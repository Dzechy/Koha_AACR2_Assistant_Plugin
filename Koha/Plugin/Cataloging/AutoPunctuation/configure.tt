[% INCLUDE 'doc-head-open.inc' %]
<title>Koha: Koha_AACR2_Assistant_Plugin Configuration</title>
[% INCLUDE 'doc-head-close.inc' %]
[% INCLUDE 'calendar.inc' %]
<style>
    :root {
        --aacr2-accent: #408540;
        --aacr2-accent-soft: #eaf4ea;
        --aacr2-border: #d7dde6;
        --aacr2-surface: #f4f7fb;
        --aacr2-card: #ffffff;
        --aacr2-muted: #5b6b7c;
        --aacr2-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
    }
    #custom-rules-editor {
        width: 100%;
        height: 400px;
        border: 1px solid var(--aacr2-border);
        font-family: monospace;
        border-radius: 6px;
    }
    .exclusion-list {
        width: 100%;
        min-height: 60px;
        border-radius: 6px;
        border: 1px solid var(--aacr2-border);
    }
    .configuration-section {
        background: var(--aacr2-card);
        border: 1px solid var(--aacr2-border);
        border-radius: 8px;
        margin-bottom: 24px;
        box-shadow: var(--aacr2-shadow);
    }
    .configuration-section legend {
        background: var(--aacr2-accent);
        color: white;
        padding: 8px 16px;
        border-radius: 8px 8px 0 0;
        margin: 0;
        width: 100%;
        font-size: 13px;
        letter-spacing: 0.3px;
        text-transform: uppercase;
    }
    .configuration-section .rows {
        padding: 18px 18px 12px 18px;
        margin: 0;
    }
    .configuration-section ol.rows {
        list-style: none;
    }
    .configuration-section .rows > li {
        padding: 10px 0;
        border-bottom: 1px dashed var(--aacr2-border);
    }
    .configuration-section .rows > li > label {
        display: inline-block;
        min-width: 260px;
        margin-right: 8px;
        vertical-align: top;
        font-weight: 600;
    }
    .configuration-section .rows ul {
        margin: 8px 0 8px 18px;
        padding-left: 18px;
    }
    .configuration-section .rows p {
        margin: 0 0 8px;
    }
    @media (max-width: 768px) {
        .configuration-section .rows > li > label {
            display: block;
            min-width: 0;
            margin-right: 0;
            margin-bottom: 6px;
        }
    }
    @media (max-width: 991px) {
        .main .row > [class*="col-sm-"] {
            float: none;
            width: 100%;
            left: auto;
            right: auto;
        }
        .table-tools,
        .openrouter-filters,
        .progress-controls {
            flex-direction: column;
            align-items: stretch;
        }
        .table-tools .form-control,
        .openrouter-filters .form-control,
        .progress-controls .form-control {
            width: 100% !important;
            max-width: 100% !important;
        }
        .configuration-section .rows {
            padding: 14px 12px 10px 12px;
        }
    }
    .configuration-section .rows > li:last-child {
        border-bottom: none;
    }
    .hint {
        color: var(--aacr2-muted);
        font-size: 12px;
        font-style: normal;
        display: block;
        margin-top: 3px;
    }
    .alert-success {
        background: #dff0d8;
        border: 1px solid #d6e9c6;
        color: #408540;
        padding: 10px;
        border-radius: 4px;
    }
    .select2-container {
        width: 100% !important;
    }
    #llm_api_provider {
        max-width: 260px;
        width: 260px;
    }
    .configuration-section .rows > li.field-stack > label {
        display: block;
        min-width: 0;
        margin-right: 0;
        margin-bottom: 6px;
    }
    .configuration-section .rows > li.field-stack .field-stack-control {
        max-width: 260px;
    }
    #llm_api_provider + .select2-container {
        max-width: 260px;
        width: 260px !important;
        min-width: 180px;
        display: block !important;
    }
    #llm_api_provider + .select2-container .select2-selection__rendered {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .user-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--aacr2-card);
        border-radius: 8px;
        overflow: hidden;
    }
    .user-table th, .user-table td {
        border: 1px solid var(--aacr2-border);
        padding: 8px;
    }
    .user-table th {
        background-color: var(--aacr2-surface);
    }
    .user-table th.sortable,
    .coverage-table th.sortable {
        cursor: pointer;
        position: relative;
        padding-right: 24px;
    }
    .user-table th.sortable::before,
    .user-table th.sortable::after,
    .coverage-table th.sortable::before,
    .coverage-table th.sortable::after {
        content: '';
        position: absolute;
        right: 8px;
        width: 0;
        height: 0;
        border-left: 4px solid transparent;
        border-right: 4px solid transparent;
    }
    .user-table th.sortable::before,
    .coverage-table th.sortable::before {
        top: 38%;
        border-bottom: 5px solid #a3b0be;
    }
    .user-table th.sortable::after,
    .coverage-table th.sortable::after {
        top: 54%;
        border-top: 5px solid #a3b0be;
    }
    .user-table th.sortable.sort-asc::before,
    .coverage-table th.sortable.sort-asc::before {
        border-bottom-color: #2f6f9f;
    }
    .user-table th.sortable.sort-asc::after,
    .coverage-table th.sortable.sort-asc::after {
        border-top-color: #c6d1dc;
    }
    .user-table th.sortable.sort-desc::before,
    .coverage-table th.sortable.sort-desc::before {
        border-bottom-color: #c6d1dc;
    }
    .user-table th.sortable.sort-desc::after,
    .coverage-table th.sortable.sort-desc::after {
        border-top-color: #2f6f9f;
    }
    .table-tools {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
        align-items: center;
    }
    .table-tools input[type="text"] {
        max-width: 280px;
    }
    .openrouter-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
        align-items: center;
    }
    .openrouter-filters label {
        margin: 0;
        font-weight: normal;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .progress-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
        align-items: center;
    }
    .disabled-checkbox {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .ai-key-indicator {
        display: inline-block;
        margin-left: 6px;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
    }
    .ai-key-indicator.is-set {
        background: #eaf4ea;
        color: #408540;
    }
    .ai-key-indicator.is-empty {
        background: #f5f5f5;
        color: #8a8a8a;
    }
    .warning-text {
        color: red;
        font-weight: bold;
    }
    .ai-prompt-editor {
        width: 100%;
        min-height: 180px;
        border-radius: 6px;
        border: 1px solid var(--aacr2-border);
        font-family: monospace;
        transition: border-color 0.2s ease, background-color 0.2s ease;
    }
    .coverage-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .coverage-table th, .coverage-table td {
        border: 1px solid var(--aacr2-border);
        padding: 6px 8px;
        font-size: 12px;
    }
    .coverage-table th {
        background: var(--aacr2-surface);
    }
    .coverage-status-covered { color: #408540; font-weight: bold; }
    .coverage-status-excluded { color: #8a6d3b; font-weight: bold; }
    .coverage-status-missing { color: #a94442; font-weight: bold; }
    .aacr2-tabs.nav-tabs {
        border-bottom: none;
        gap: 12px;
        margin-bottom: 6px;
    }
    .aacr2-tabs .nav-link {
        border: none;
        padding: 0;
        background: transparent;
        color: var(--aacr2-muted);
        text-decoration: underline;
        text-decoration-color: transparent;
        text-underline-offset: 4px;
        font-weight: 600;
    }
    .aacr2-tabs .nav-link:hover,
    .aacr2-tabs .nav-link:focus {
        color: var(--aacr2-accent);
        text-decoration-color: var(--aacr2-accent);
    }
    .aacr2-tabs .nav-link.active {
        color: var(--aacr2-accent);
        text-decoration-color: var(--aacr2-accent);
    }
</style>
<meta name="aacr2-plugin-csrf-token" content="[% csrf_token %]"/>
</head>
<body>
[% INCLUDE 'header.inc' %]
[% INCLUDE 'cat-search.inc' %]
<div id="breadcrumbs">
    <a href="/cgi-bin/koha/mainpage.pl">Home</a> ›
    <a href="/cgi-bin/koha/plugins/plugins-home.pl">Plugins</a> ›
    <a href="#" class="active">Koha_AACR2_Assistant_Plugin Configuration</a>
</div>
<div class="main container-fluid">
    <div class="row">
        <div class="col-sm-10 col-sm-push-2">
            <main>
                <h1>Koha_AACR2_Assistant_Plugin Configuration</h1>

                [% IF settings.last_updated && !(save_errors && save_errors.size) %]
                <div class="alert alert-success">
                    <p><i class="fa fa-check-circle"></i> Last updated: [% settings.last_updated %]</p>
                </div>
                [% END %]
                [% IF save_errors && save_errors.size %]
                <div class="alert alert-danger">
                    <p><strong>Unable to save configuration:</strong></p>
                    <ul>
                        [% FOREACH err IN save_errors %]
                            <li>[% err %]</li>
                        [% END %]
                    </ul>
                </div>
                [% END %]
                [% IF saved_successfully && !(save_errors && save_errors.size) %]
                <div class="alert alert-success">
                    <p><i class="fa fa-check-circle"></i> Settings saved successfully.</p>
                </div>
                [% END %]
                [% IF update_info && update_info.update_available %]
                <div class="alert alert-warning" id="aacr2-update-alert">
                    <p><i class="fa fa-exclamation-circle"></i> New release available: [% update_info.latest_version %] (current [% current_version %]).</p>
                    <p><a href="[% update_info.release_url %]" target="_blank" rel="noopener">View release on GitHub</a></p>
                </div>
                [% END %]
                <div class="alert alert-info">
                    <p><strong>Author LinkedIn:</strong> <a href="[% author_linkedin %]" target="_blank" rel="noopener">[% author_linkedin %]</a></p>
                    <p><strong>Plugin GitHub:</strong> <a href="[% plugin_repo_url %]" target="_blank" rel="noopener">[% plugin_repo_url %]</a></p>
                    <p><strong>Run Tool:</strong> <a href="/cgi-bin/koha/plugins/run.pl?class=[% CLASS %]&method=tool">Open tool page</a></p>
                </div>

                <form method="post" enctype="multipart/form-data" action="/cgi-bin/koha/plugins/run.pl?class=[% CLASS %]&method=[% METHOD %]" data-plugin-csrf-token="[% csrf_token %]">
                    <input type="hidden" name="class" value="[% CLASS %]"/>
                    <input type="hidden" name="method" value="[% METHOD %]"/>
                    <input type="hidden" name="op" value="save_configuration"/>
                    <input type="hidden" name="save" value="1"/>
                    <input type="hidden" name="csrf_token" id="csrf_token" value="[% csrf_token %]"/>

                    <ul class="nav nav-tabs aacr2-tabs" id="aacr2-config-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" href="#aacr2-tab-general" data-bs-toggle="tab" role="tab" aria-controls="aacr2-tab-general" aria-selected="true">General</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" href="#aacr2-tab-ai" data-bs-toggle="tab" role="tab" aria-controls="aacr2-tab-ai" aria-selected="false">AI Assist</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" href="#aacr2-tab-rules" data-bs-toggle="tab" role="tab" aria-controls="aacr2-tab-rules" aria-selected="false">Rules &amp; Validation</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" href="#aacr2-tab-training" data-bs-toggle="tab" role="tab" aria-controls="aacr2-tab-training" aria-selected="false">Training</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" href="#aacr2-tab-advanced" data-bs-toggle="tab" role="tab" aria-controls="aacr2-tab-advanced" aria-selected="false">Advanced/Debug</a>
                        </li>
                    </ul>
                    <div class="tab-content" style="margin-top: 16px;">
                        <div class="tab-pane fade show active" id="aacr2-tab-general" role="tabpanel">
                            <fieldset class="configuration-section">
                                <legend>Basic Settings</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="enabled">Enable AACR2 Intellisense:</label>
                                        <input type="checkbox" name="enabled" id="enabled" value="1" [% IF settings.enabled %]checked[% END %]/>
                                        <span class="hint">Turn AACR2 checks on for cataloging forms.</span>
                                    </li>
                                    <li>
                                        <label for="auto_apply_punctuation">Auto-Apply Fixes:</label>
                                        <input type="checkbox" name="auto_apply_punctuation" id="auto_apply_punctuation" value="1" [% IF settings.auto_apply_punctuation %]checked[% END %]/>
                                        <span class="hint">Off = suggestions only. On = apply fixes automatically.</span>
                                    </li>
                                    <li>
                                        <label for="default_standard">Cataloging Standard:</label>
                                        <select name="default_standard" id="default_standard" class="form-control" style="width: auto; display: inline-block;">
                                            <option value="AACR2" selected>AACR2</option>
                                        </select>
                                        <span class="hint">AACR2 is used for MARC21 punctuation rules.</span>
                                    </li>
                                </ol>
                            </fieldset>
                        </div>
                        <div class="tab-pane fade" id="aacr2-tab-ai" role="tabpanel">
                            <fieldset class="configuration-section">
                                <legend>AI Assist (Optional)</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="ai_enable">Enable AI Assist:</label>
                                        <input type="checkbox" name="ai_enable" id="ai_enable" value="1" [% IF settings.ai_enable %]checked[% END %]/>
                                        <span class="hint">Suggestions only. Review before saving.</span>
                                    </li>
                                    <li>
                                        <label for="ai_punctuation_explain">AI Field Guidance:</label>
                                        <input type="checkbox" name="ai_punctuation_explain" id="ai_punctuation_explain" value="1" [% IF settings.ai_punctuation_explain %]checked[% END %]/>
                                        <span class="hint">Show AACR2 punctuation guidance for the selected field.</span>
                                    </li>
                                    <li>
                                        <label for="ai_subject_guidance">AI Subject Guidance:</label>
                                        <input type="checkbox" name="ai_subject_guidance" id="ai_subject_guidance" value="1" [% IF settings.ai_subject_guidance %]checked[% END %]/>
                                        <span class="hint">Suggest subject headings from title source.</span>
                                    </li>
                                    <li>
                                        <label for="ai_callnumber_guidance">AI Call Number Guidance:</label>
                                        <input type="checkbox" name="ai_callnumber_guidance" id="ai_callnumber_guidance" value="1" [% IF settings.ai_callnumber_guidance %]checked[% END %]/>
                                        <span class="hint">Suggest an LC class number from title source.</span>
                                    </li>
                                    <li>
                                        <label for="lc_class_target">LC Classification Target (tag$subfield):</label>
                                        <input type="text" name="lc_class_target" id="lc_class_target" value="[% settings.lc_class_target || '050$a' %]" class="form-control" style="width: 140px;"/>
                                        <span class="hint">Where suggested class numbers are written (example: 050$a).</span>
                                    </li>
                                    <li class="field-stack">
                                        <label for="llm_api_provider">AI Provider:</label>
                                        [% SET ai_provider_norm = (settings.llm_api_provider || 'OpenRouter') | lower %]
                                        <div class="field-stack-control">
                                            <select name="llm_api_provider" id="llm_api_provider" class="form-control" style="width: 260px; max-width: 100%;">
                                                <option value="OpenRouter" [% IF ai_provider_norm == 'openrouter' %]selected[% END %]>OpenRouter (recommended)</option>
                                                <option value="OpenAI" [% IF ai_provider_norm == 'openai' %]selected[% END %]>OpenAI</option>
                                            </select>
                                        </div>
                                        <span class="hint">Choose OpenRouter or OpenAI.</span>
                                    </li>
                                    [% IF !encryption_ready %]
                                    <li>
                                        <div class="alert alert-warning" style="margin: 6px 0;">
                                            <strong>Encryption key missing:</strong>
                                            Koha encryption_key is not configured in koha-conf.xml. API keys cannot be saved until it is set.
                                        </div>
                                    </li>
                                    [% END %]
                                    <li id="ai-api-key-row"
                                        data-openai-set="[% llm_api_key_ready ? 1 : 0 %]"
                                        data-openrouter-set="[% openrouter_api_key_ready ? 1 : 0 %]"
                                        data-openai-present="[% llm_api_key_set ? 1 : 0 %]"
                                        data-openrouter-present="[% openrouter_api_key_set ? 1 : 0 %]">
                                        <label for="ai_api_key" id="ai-api-key-label">API Key:</label>
                                        <span id="ai-api-key-indicator" class="ai-key-indicator"></span>
                                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                            <input type="password" name="ai_api_key" id="ai_api_key" value="" class="form-control" style="width: 300px;" autocomplete="new-password"/>
                                            <button type="button" class="btn btn-xs btn-danger" id="clear-ai-key" disabled>Clear key</button>
                                        </div>
                                        <input type="hidden" name="ai_api_key_clear" id="ai_api_key_clear" value="0"/>
                                        <span class="hint" id="ai-api-key-hint"></span>
                                    </li>
                                    <li id="ai-model-row">
                                        <label for="ai_model">Model:</label>
                                        <div class="table-tools">
                                            <input type="text" id="ai-model-search" class="form-control input-sm" style="width: 320px;" placeholder="Search OpenRouter models..."/>
                                            <select name="ai_model" id="ai_model" class="form-control" style="width: 460px;"></select>
                                            <button type="button" class="btn btn-xs btn-default" id="refresh-ai-models">
                                                <i class="fa fa-refresh"></i> Refresh
                                            </button>
                                        </div>
                                        <div class="openrouter-filters">
                                            <label><input type="checkbox" id="openrouter-filter-text" checked/> text</label>
                                            <label><input type="checkbox" id="openrouter-filter-image"/> image</label>
                                            <label><input type="checkbox" id="openrouter-filter-input" checked/> input</label>
                                            <label><input type="checkbox" id="openrouter-filter-output" checked/> output</label>
                                            <label><input type="checkbox" id="openrouter-filter-free"/> free</label>
                                        </div>
                                        <span class="hint" id="ai-model-hint"></span>
                                    </li>
                                    <li>
                                        <button type="button" class="btn btn-default" id="ai-test-connection">
                                            <i class="fa fa-plug"></i> Test Connection
                                        </button>
                                        <span class="hint">Run a quick provider connectivity check.</span>
                                    </li>
                                    <li>
                                        <label for="ai_prompt_default">Default AI Prompt (punctuation guidance):</label>
                                        <textarea name="ai_prompt_default" id="ai_prompt_default" class="ai-prompt-editor form-control" maxlength="[% ai_prompt_max_length || 16384 %]">[% settings.ai_prompt_default | html %]</textarea>
                                        <span class="hint" id="ai_prompt_default_hint">Prompt for punctuation suggestions. Max [% ai_prompt_max_length || 16384 %] chars.</span>
                                    </li>
                                    <li>
                                        <label for="ai_prompt_cataloging">Cataloging Prompt (classification/subjects):</label>
                                        <textarea name="ai_prompt_cataloging" id="ai_prompt_cataloging" class="ai-prompt-editor form-control" maxlength="[% ai_prompt_max_length || 16384 %]">[% settings.ai_prompt_cataloging | html %]</textarea>
                                        <span class="hint" id="ai_prompt_cataloging_hint">Prompt for class/subject suggestions. Leave blank for built-in default. Supports {{source_text}}.</span>
                                    </li>
                                    <li>
                                        <button type="button" class="btn btn-default btn-sm" id="reset-ai-prompts">
                                            <i class="fa fa-undo"></i> Reset Prompts To Defaults
                                        </button>
                                        <span class="hint">Restore built-in prompts. Save to keep changes.</span>
                                    </li>
                                </ol>
                            </fieldset>
                        </div>
                        <div class="tab-pane fade" id="aacr2-tab-rules" role="tabpanel">
                            <fieldset class="configuration-section">
                                <legend>AACR2 Rules &amp; Live Validation</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="enforce_aacr2_guardrails">Enforce AACR2 Guardrails:</label>
                                        <input type="checkbox" name="enforce_aacr2_guardrails" id="enforce_aacr2_guardrails" value="1" [% IF settings.enforce_aacr2_guardrails %]checked[% END %]/>
                                        <span class="hint">Enforce AACR2 rules strictly.</span>
                                    </li>
                                    <li>
                                        <label for="enable_live_validation">Enable Live Validation:</label>
                                        <input type="checkbox" name="enable_live_validation" id="enable_live_validation" value="1" [% IF settings.enable_live_validation %]checked[% END %]/>
                                        <span class="hint">Show rule issues while typing.</span>
                                    </li>
                                    <li>
                                        <label for="block_save_on_error">Block Save on Errors:</label>
                                        <input type="checkbox" name="block_save_on_error" id="block_save_on_error" value="1" [% IF settings.block_save_on_error %]checked[% END %]/>
                                        <span class="hint">Block save when required AACR2 issues remain.</span>
                                    </li>
                                    <li>
                                        <label for="required_fields">Required AACR2 Fields:</label>
                                        <input type="text" name="required_fields" id="required_fields" value="[% settings.required_fields || '0030,0080,040c,942c,100a,245a,260c,300a,050a' %]" class="form-control"/>
                                        <span class="hint">Comma-separated required subfields (example: 100a,245a).</span>
                                    </li>
                                    <li>
                                        <label for="excluded_tags">Excluded Tags (Optional):</label>
                                        <input type="text" name="excluded_tags" id="excluded_tags" value="[% settings.excluded_tags %]" class="form-control"/>
                                        <span class="hint">Comma-separated tags/subfields to skip (example: 590a,9XX).</span>
                                    </li>
                                    <li>
                                        <label for="strict_coverage_mode">Strict Coverage Mode:</label>
                                        <input type="checkbox" name="strict_coverage_mode" id="strict_coverage_mode" value="1" [% IF settings.strict_coverage_mode %]checked[% END %]/>
                                        <span class="hint">Warn when a field has no matching rule.</span>
                                    </li>
                                    <li>
                                        <label for="enable_local_fields">Enable Local (9XX) Fields:</label>
                                        <input type="checkbox" name="enable_local_fields" id="enable_local_fields" value="1" [% IF settings.enable_local_fields %]checked[% END %]/>
                                        <span class="hint">Include local fields in AACR2 checks.</span>
                                    </li>
                                    <li>
                                        <label for="local_fields_allowlist">Local Fields Allowlist:</label>
                                        <input type="text" name="local_fields_allowlist" id="local_fields_allowlist" value="[% settings.local_fields_allowlist %]" class="form-control"/>
                                        <span class="hint">Comma-separated local fields to include (example: 9XX,952a).</span>
                                    </li>
                                </ol>
                            </fieldset>
                            <fieldset class="configuration-section">
                                <legend>Custom AACR2 Rules</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="custom-rules-editor">Custom Rules (JSON):</label>
                                        <textarea name="custom_rules" id="custom-rules-editor">[% settings.custom_rules || '{}' %]</textarea>
                                        <span class="hint">Optional custom rules JSON (format: {"rules":[...]})</span>
                                    </li>
                                    <li>
                                        <label>Import/Export Rules:</label>
                                        <div style="margin-top: 5px;">
                                            <input type="file" name="rules_file" id="rules_file" accept=".json" class="form-control" style="width: auto; display: inline-block;"/>
                                            <button type="submit" name="import_rules" value="1" class="btn btn-default">
                                                <i class="fa fa-upload"></i> Import Rules
                                            </button>
                                            <button type="submit" name="export_rules" value="1" class="btn btn-default">
                                                <i class="fa fa-download"></i> Export Rules
                                            </button>
                                        </div>
                                        <span class="hint">Import rules from JSON or export current rules.</span>
                                    </li>
                                </ol>
                            </fieldset>
                            <fieldset class="configuration-section">
                                <legend>Coverage Report</legend>
                                <div class="rows">
                                    <p>Baseline rule pack version: <strong>[% rules_version || 'unknown' %]</strong></p>
                                    <p>
                                        Covered: <strong>[% coverage_summary.covered %]</strong> ·
                                        Excluded: <strong>[% coverage_summary.excluded %]</strong> ·
                                        Not covered: <strong>[% coverage_summary.not_covered %]</strong>
                                    </p>
                                    <span class="hint">Shows rule coverage against active MARC frameworks.</span>
                                    [% FOREACH framework IN coverage_report %]
                                        <details style="margin-top: 10px;">
                                            <summary>
                                                [% framework.frameworktext || framework.frameworkcode || 'Default' %]
                                                (Total: [% framework.counts.total %], Covered: [% framework.counts.covered %], Excluded: [% framework.counts.excluded %], Missing: [% framework.counts.not_covered %])
                                            </summary>
                                            <table class="coverage-table">
                                                <thead>
                                                    <tr>
                                                        <th class="sortable" data-sort="tag">Tag</th>
                                                        <th class="sortable" data-sort="subfield">Subfield</th>
                                                        <th class="sortable" data-sort="status">Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    [% FOREACH field IN framework.fields %]
                                                        <tr>
                                                            <td>[% field.tag %]</td>
                                                            <td>[% field.subfield %]</td>
                                                            <td>
                                                                [% IF field.status == 'covered' %]
                                                                    <span class="coverage-status-covered">Covered</span>
                                                                [% ELSIF field.status == 'excluded' %]
                                                                    <span class="coverage-status-excluded">Excluded</span>
                                                                [% ELSE %]
                                                                    <span class="coverage-status-missing">Not covered</span>
                                                                [% END %]
                                                            </td>
                                                        </tr>
                                                    [% END %]
                                                </tbody>
                                            </table>
                                        </details>
                                    [% END %]
                                    <div style="margin-top: 15px;">
                                        <label for="coverage-stubs">Recommended Rule Stubs (JSON):</label>
                                        <textarea id="coverage-stubs" class="form-control" rows="8" readonly>[% coverage_stubs_json %]</textarea>
                                        <span class="hint">Use these stubs to extend custom rules.</span>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                        <div class="tab-pane fade" id="aacr2-tab-training" role="tabpanel">
                            <fieldset class="configuration-section">
                                <legend>Interactive Training Guide</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="enable_guide">Enable Interactive AACR2 Guide:</label>
                                        <input type="checkbox" name="enable_guide" id="enable_guide" value="1" [% IF settings.enable_guide %]checked[% END %]/>
                                        <span class="hint">Enable the step-by-step training guide.</span>
                                    </li>
                                    <li>
                                        <label for="guide_users">Exclude Users from Guide:</label>
                                        <div class="table-tools">
                                            <input type="text" id="guide-user-search" class="form-control input-sm" placeholder="Search users..."/>
                                            <select id="guide-user-filter" class="form-control input-sm" style="width: 160px;">
                                                <option value="all">All</option>
                                                <option value="selected">Selected</option>
                                                <option value="unselected">Unselected</option>
                                            </select>
                                        </div>
                                        <table class="user-table" id="guide-users-table">
                                            <thead>
                                                <tr>
                                                    <th>
                                                        <input type="checkbox" id="selectAllGuideUsers" onclick="toggleSelectAll('guide_users', this.checked)"/>
                                                    </th>
                                                    <th class="sortable" data-sort="userid">User ID</th>
                                                    <th class="sortable" data-sort="name">Name</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                [% FOREACH user IN users %]
                                                <tr>
                                                    <td>
                                                        <input type="checkbox" name="guide_users" value="[% user.userid %]"
                                                        [% FOREACH selected_user IN settings.guide_users.split(',') %]
                                                            [% IF selected_user.trim == user.userid %]checked[% END %]
                                                        [% END %]
                                                        [% IF !settings.enable_guide %]disabled class="disabled-checkbox"[% END %]>
                                                    </td>
                                                    <td>[% user.userid %]</td>
                                                    <td>[% user.name %]</td>
                                                </tr>
                                                [% END %]
                                            </tbody>
                                        </table>
                                        <span class="hint">Selected users are excluded from the guide.</span>
                                    </li>
                                    <li>
                                        <label for="guide_exclusion_list">Manual Exclusion List (Optional):</label>
                                        <textarea name="guide_exclusion_list" id="guide_exclusion_list" class="exclusion-list form-control">[% settings.guide_exclusion_list %]</textarea>
                                        <span class="hint">Optional comma-separated usernames to exclude.</span>
                                    </li>
                                </ol>
                            </fieldset>
                            <fieldset class="configuration-section">
                                <legend>Internship Training Mode</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="internship_mode">Enable Internship Mode:</label>
                                        <input type="checkbox" name="internship_mode" id="internship_mode" value="1" [% IF settings.internship_mode %]checked[% END %]/>
                                        <span class="hint">Turn off auto-punctuation for selected trainees.</span>
                                    </li>
                                    <li>
                                        <label for="internship_users">Select Internship Users:</label>
                                        <div class="table-tools">
                                            <input type="text" id="internship-user-search" class="form-control input-sm" placeholder="Search users..."/>
                                            <select id="internship-user-filter" class="form-control input-sm" style="width: 160px;">
                                                <option value="all">All</option>
                                                <option value="selected">Selected</option>
                                                <option value="unselected">Unselected</option>
                                            </select>
                                        </div>
                                        <table class="user-table" id="internship-users-table">
                                            <thead>
                                                <tr>
                                                    <th>
                                                        <input type="checkbox" id="selectAllInternshipUsers" onclick="toggleSelectAll('internship_users', this.checked)"/>
                                                    </th>
                                                    <th class="sortable" data-sort="userid">User ID</th>
                                                    <th class="sortable" data-sort="name">Name</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                [% FOREACH user IN users %]
                                                <tr>
                                                    <td>
                                                        <input type="checkbox" name="internship_users" value="[% user.userid %]"
                                                        [% FOREACH selected_user IN settings.internship_users.split(',') %]
                                                            [% IF selected_user.trim == user.userid %]checked[% END %]
                                                        [% END %]
                                                        [% IF !settings.internship_mode %]disabled class="disabled-checkbox"[% END %]>
                                                    </td>
                                                    <td>[% user.userid %]</td>
                                                    <td>[% user.name %]</td>
                                                </tr>
                                                [% END %]
                                            </tbody>
                                        </table>
                                        <span class="hint">Selected users will not get auto-punctuation.</span>
                                    </li>
                                    <li>
                                        <label for="internship_exclusion_list">Manual Exclusion List:</label>
                                        <textarea name="internship_exclusion_list" id="internship_exclusion_list" class="exclusion-list form-control">[% settings.internship_exclusion_list %]</textarea>
                                        <span class="hint">Optional comma-separated usernames to exclude.</span>
                                    </li>
                                    <li>
                                        <label>Intern Access Controls:</label>
                                        <div style="display:flex; flex-direction:column; gap:6px; margin-top:4px;">
                                            <label style="font-weight:normal;"><input type="checkbox" class="internship-access-control" name="intern_allow_assistant_toggle" id="intern_allow_assistant_toggle" value="1" [% IF settings.intern_allow_assistant_toggle %]checked[% END %] [% IF !settings.internship_mode %]disabled[% END %]/> Allow AACR2 Assistant toggle</label>
                                            <label style="font-weight:normal;"><input type="checkbox" class="internship-access-control" name="intern_allow_autoapply_toggle" id="intern_allow_autoapply_toggle" value="1" [% IF settings.intern_allow_autoapply_toggle %]checked[% END %] [% IF !settings.internship_mode %]disabled[% END %]/> Allow Auto-apply toggle</label>
                                            <label style="font-weight:normal;"><input type="checkbox" class="internship-access-control" name="intern_allow_cataloging_panel" id="intern_allow_cataloging_panel" value="1" [% IF settings.intern_allow_cataloging_panel %]checked[% END %] [% IF !settings.internship_mode %]disabled[% END %]/> Allow Cataloging Assistant panel toggle</label>
                                            <label style="font-weight:normal;"><input type="checkbox" class="internship-access-control" name="intern_allow_ai_assist_toggle" id="intern_allow_ai_assist_toggle" value="1" [% IF settings.intern_allow_ai_assist_toggle %]checked[% END %] [% IF !settings.internship_mode %]disabled[% END %]/> Allow AI Assist toggle</label>
                                            <label style="font-weight:normal;"><input type="checkbox" class="internship-access-control" name="intern_allow_panel_apply_actions" id="intern_allow_panel_apply_actions" value="1" [% IF settings.intern_allow_panel_apply_actions %]checked[% END %] [% IF !settings.internship_mode %]disabled[% END %]/> Allow apply/undo actions in Cataloging Assistant panel</label>
                                            <label style="font-weight:normal;"><input type="checkbox" class="internship-access-control" name="intern_allow_ai_cataloging" id="intern_allow_ai_cataloging" value="1" [% IF settings.intern_allow_ai_cataloging %]checked[% END %] [% IF !settings.internship_mode %]disabled[% END %]/> Allow AI cataloging requests</label>
                                            <label style="font-weight:normal;"><input type="checkbox" class="internship-access-control" name="intern_allow_ai_punctuation" id="intern_allow_ai_punctuation" value="1" [% IF settings.intern_allow_ai_punctuation %]checked[% END %] [% IF !settings.internship_mode %]disabled[% END %]/> Allow AI punctuation requests</label>
                                            <label style="font-weight:normal;"><input type="checkbox" class="internship-access-control" name="intern_allow_ai_apply_actions" id="intern_allow_ai_apply_actions" value="1" [% IF settings.intern_allow_ai_apply_actions %]checked[% END %] [% IF !settings.internship_mode %]disabled[% END %]/> Allow AI panel apply actions (subjects, classification, call number, AI patch apply)</label>
                                        </div>
                                        <span class="hint">These controls apply only to users selected in internship mode.</span>
                                    </li>
                                </ol>
                            </fieldset>
                            <fieldset class="configuration-section">
                                <legend>Training Progress</legend>
                                <div class="rows">
                                    <div class="progress-controls">
                                        <input type="text" id="progress-search" class="form-control input-sm" placeholder="Search users..."/>
                                        <select id="progress-status-filter" class="form-control input-sm" style="width: 180px;">
                                            <option value="all">All statuses</option>
                                            <option value="completed">Completed</option>
                                            <option value="in_progress">In progress</option>
                                            <option value="not_started">Not started</option>
                                        </select>
                                        <select id="progress-tier-filter" class="form-control input-sm" style="width: 170px;">
                                            <option value="all">All tiers</option>
                                        </select>
                                        <select id="progress-module-filter" class="form-control input-sm" style="width: 260px;">
                                            <option value="all">All modules</option>
                                        </select>
                                        <button type="button" class="btn btn-default btn-sm" id="progress-refresh">
                                            <i class="fa fa-refresh"></i> Refresh
                                        </button>
                                        <button type="button" class="btn btn-default btn-sm" id="progress-export-csv">
                                            <i class="fa fa-download"></i> Export CSV
                                        </button>
                                        <button type="button" class="btn btn-default btn-sm" id="progress-export-excel">
                                            <i class="fa fa-table"></i> Export Excel
                                        </button>
                                        <label style="font-weight: normal;">
                                            <input type="checkbox" id="progress-auto-refresh" checked/> Auto-refresh (30s)
                                        </label>
                                    </div>
                                    <table class="user-table" id="aacr2-progress-table">
                                        <thead>
                                            <tr>
                                                <th class="sortable" data-sort="userid">User ID</th>
                                                <th class="sortable" data-sort="name">Name</th>
                                                <th class="sortable" data-sort="tier">Tier</th>
                                                <th class="sortable" data-sort="module">Module</th>
                                                <th class="sortable" data-sort="steps_completed">Module Steps Done</th>
                                                <th class="sortable" data-sort="steps_skipped">Module Steps Skipped</th>
                                                <th class="sortable" data-sort="total_steps_completed">Total Steps Done</th>
                                                <th class="sortable" data-sort="total_steps_skipped">Total Steps Skipped</th>
                                                <th class="sortable" data-sort="summary">Completion Progress</th>
                                                <th class="sortable" data-sort="updated_at">Last Updated</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="10">Loading progress...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <span class="hint">Updates as staff use the training guide.</span>
                                </div>
                            </fieldset>
                        </div>
                        <div class="tab-pane fade" id="aacr2-tab-advanced" role="tabpanel">
                            <fieldset class="configuration-section">
                                <legend>Debug &amp; Preview</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="debug_mode">Debug Mode:</label>
                                        <input type="checkbox" name="debug_mode" id="debug_mode" value="1" [% IF settings.debug_mode %]checked[% END %]/>
                                        <span class="hint">Enable extra logs for troubleshooting.</span>
                                    </li>
                                    <li>
                                        <label for="ai_debug_include_raw_response">Include Raw AI Provider Debug Payload:</label>
                                        <input type="checkbox" name="ai_debug_include_raw_response" id="ai_debug_include_raw_response" value="1" [% IF settings.ai_debug_include_raw_response %]checked[% END %]/>
                                        <span class="hint">Include sanitized raw provider text for debugging.</span>
                                    </li>
                                    <li>
                                        <label for="ai_payload_preview">Enable Payload Preview:</label>
                                        <input type="checkbox" name="ai_payload_preview" id="ai_payload_preview" value="1" [% IF settings.ai_payload_preview %]checked[% END %]/>
                                        <span class="hint">Preview the payload sent to AI.</span>
                                    </li>
                                </ol>
                            </fieldset>
                            <fieldset class="configuration-section">
                                <legend>AI Safety &amp; Context</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="ai_redaction_rules">Redaction Rules:</label>
                                        <input type="text" name="ai_redaction_rules" id="ai_redaction_rules" value="[% settings.ai_redaction_rules %]" class="form-control"/>
                                        <span class="hint">Hide these tags/subfields before AI requests.</span>
                                    </li>
                                    <li>
                                        <label for="ai_redact_856_querystrings">Redact 856 $u Querystrings:</label>
                                        <input type="checkbox" name="ai_redact_856_querystrings" id="ai_redact_856_querystrings" value="1" [% IF settings.ai_redact_856_querystrings %]checked[% END %]/>
                                        <span class="hint">Strip query strings from 856$u links.</span>
                                    </li>
                                    <li>
                                        <label for="ai_context_mode">AI Context Scope:</label>
                                        <select name="ai_context_mode" id="ai_context_mode" class="form-control" style="width: 240px;">
                                            <option value="tag_only" [% IF settings.ai_context_mode == 'tag_only' %]selected[% END %]>Tag only (default)</option>
                                            <option value="tag_plus_neighbors" [% IF settings.ai_context_mode == 'tag_plus_neighbors' %]selected[% END %]>Tag + neighboring fields</option>
                                            <option value="full" [% IF settings.ai_context_mode == 'full' %]selected[% END %]>Full record (redacted)</option>
                                        </select>
                                        <span class="hint">Choose how much record context is sent to AI.</span>
                                    </li>
                                </ol>
                            </fieldset>
                            <fieldset class="configuration-section">
                                <legend>AI Tuning &amp; Limits</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="ai_reasoning_effort">Reasoning/Thinking Effort (OpenAI reasoning models only):</label>
                                        [% SET reasoning_effort = (settings.ai_reasoning_effort || 'low') | lower %]
                                        <select name="ai_reasoning_effort" id="ai_reasoning_effort" class="form-control" style="width: 180px;">
                                            <option value="none" [% IF reasoning_effort == 'none' %]selected[% END %]>None</option>
                                            <option value="low" [% IF reasoning_effort == 'low' %]selected[% END %]>Low</option>
                                            <option value="medium" [% IF reasoning_effort == 'medium' %]selected[% END %]>Medium</option>
                                            <option value="high" [% IF reasoning_effort == 'high' %]selected[% END %]>High</option>
                                        </select>
                                        <span class="hint">For reasoning models only. Higher effort can be slower/costlier.</span>
                                    </li>
                                    <li>
                                        <label for="ai_timeout">Timeout (seconds):</label>
                                        <input type="number" name="ai_timeout" id="ai_timeout" value="[% settings.ai_timeout %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Request timeout in seconds.</span>
                                    </li>
                                    <li>
                                        <label for="ai_max_output_tokens">Max Output Tokens:</label>
                                        <input type="number" name="ai_max_output_tokens" id="ai_max_output_tokens" value="[% settings.ai_max_output_tokens %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Max output tokens per response.</span>
                                    </li>
                                    <li>
                                        <label for="ai_temperature">Temperature:</label>
                                        <input type="text" name="ai_temperature" id="ai_temperature" value="[% settings.ai_temperature %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Lower is steadier; higher is more varied.</span>
                                    </li>
                                    <li>
                                        <label for="ai_confidence_threshold">Ghost Confidence Threshold:</label>
                                        <input type="text" name="ai_confidence_threshold" id="ai_confidence_threshold" value="[% settings.ai_confidence_threshold %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Show ghost text only above this confidence.</span>
                                    </li>
                                    <li>
                                        <label for="ai_rate_limit_per_minute">Rate Limit (per minute):</label>
                                        <input type="number" name="ai_rate_limit_per_minute" id="ai_rate_limit_per_minute" value="[% settings.ai_rate_limit_per_minute %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Per-user AI request limit per minute.</span>
                                    </li>
                                    <li>
                                        <label for="ai_cache_ttl_seconds">Cache TTL (seconds):</label>
                                        <input type="number" name="ai_cache_ttl_seconds" id="ai_cache_ttl_seconds" value="[% settings.ai_cache_ttl_seconds %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Cache AI responses for this many seconds.</span>
                                    </li>
                                    <li>
                                        <label for="ai_cache_max_entries">Cache Max Entries:</label>
                                        <input type="number" name="ai_cache_max_entries" id="ai_cache_max_entries" value="[% settings.ai_cache_max_entries %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Maximum number of cached AI responses.</span>
                                    </li>
                                    <li>
                                        <label for="ai_retry_count">Retries:</label>
                                        <input type="number" name="ai_retry_count" id="ai_retry_count" value="[% settings.ai_retry_count %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Retry count after failed AI requests.</span>
                                    </li>
                                    <li>
                                        <label for="ai_circuit_breaker_threshold">Circuit Breaker Threshold:</label>
                                        <input type="number" name="ai_circuit_breaker_threshold" id="ai_circuit_breaker_threshold" value="[% settings.ai_circuit_breaker_threshold %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Open circuit after this many consecutive failures.</span>
                                    </li>
                                    <li>
                                        <label for="ai_circuit_breaker_timeout">Circuit Breaker Timeout (seconds):</label>
                                        <input type="number" name="ai_circuit_breaker_timeout" id="ai_circuit_breaker_timeout" value="[% settings.ai_circuit_breaker_timeout %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Circuit open duration in seconds.</span>
                                    </li>
                                    <li>
                                        <label for="ai_circuit_breaker_window_seconds">Circuit Breaker Window (seconds):</label>
                                        <input type="number" name="ai_circuit_breaker_window_seconds" id="ai_circuit_breaker_window_seconds" value="[% settings.ai_circuit_breaker_window_seconds %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Failure-rate window in seconds.</span>
                                    </li>
                                    <li>
                                        <label for="ai_circuit_breaker_failure_rate">Circuit Breaker Failure Rate:</label>
                                        <input type="text" name="ai_circuit_breaker_failure_rate" id="ai_circuit_breaker_failure_rate" value="[% settings.ai_circuit_breaker_failure_rate %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Open circuit if failure rate exceeds this value (0-1).</span>
                                    </li>
                                    <li>
                                        <label for="ai_circuit_breaker_min_samples">Circuit Breaker Min Samples:</label>
                                        <input type="number" name="ai_circuit_breaker_min_samples" id="ai_circuit_breaker_min_samples" value="[% settings.ai_circuit_breaker_min_samples %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Minimum sample size before failure-rate checks apply.</span>
                                    </li>
                                </ol>
                            </fieldset>
                        </div>
                    </div>
                    <fieldset class="action">
                        <input type="submit" value="Save Configuration" class="btn btn-primary"/>
                        <a href="/cgi-bin/koha/plugins/run.pl?class=[% CLASS %]&method=tool" class="btn btn-default">Cancel</a>
                    </fieldset>
                </form>
            </main>
        </div>
        <div class="col-sm-2 col-sm-pull-10">
            <aside>
                [% INCLUDE 'tools-menu.inc' %]
            </aside>
        </div>
    </div>
</div>
<script>
    if (!window.toastr) {
        window.toastr = {
            success: function(message) { console.log(message); },
            error: function(message) { console.error(message); },
            warning: function(message) { console.warn(message); },
            info: function(message) { console.info(message); }
        };
    }

    var editorTextarea = document.getElementById('custom-rules-editor');
    var editor = {
        getValue: function() {
            return editorTextarea ? (editorTextarea.value || '') : '';
        },
        setValue: function(value) {
            if (editorTextarea) editorTextarea.value = value == null ? '' : String(value);
        }
    };
    if (window.CodeMirror && editorTextarea) {
        editor = CodeMirror.fromTextArea(editorTextarea, {
            mode: 'application/json',
            lineNumbers: true,
            theme: 'default',
            lint: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentWithTabs: false,
            indentUnit: 2
        });
    }
    var draftKey = 'aacr2-config-draft-v1';
    var draftState = null;
    var draftTimer = null;

    function escapeSelector(value) {
        if (window.CSS && CSS.escape) return CSS.escape(value);
        return value.replace(/[^\w-]/g, '\\$&');
    }

    function shouldPersistField(el) {
        var name = el.getAttribute('name') || '';
        if (!name) return false;
        if (/api_key/i.test(name)) return false;
        if (name === 'save' || name === 'class' || name === 'method') return false;
        var type = (el.getAttribute('type') || '').toLowerCase();
        if (type === 'password' || type === 'file' || type === 'hidden') return false;
        return true;
    }

    function collectDraftState() {
        var values = {};
        $('form').find('input, select, textarea').each(function() {
            if (!shouldPersistField(this)) return;
            var name = this.getAttribute('name');
            var $el = $(this);
            var type = (this.getAttribute('type') || '').toLowerCase();
            if (type === 'checkbox') {
                values[name] = $el.prop('checked');
                return;
            }
            if (type === 'radio') {
                if ($el.prop('checked')) values[name] = $el.val();
                return;
            }
            if ($el.is('select[multiple]')) {
                values[name] = $el.val() || [];
                return;
            }
            values[name] = $el.val();
        });
        values.__activeTab = $('#aacr2-config-tabs .nav-link.active').attr('href') || '';
        return { ts: Date.now(), values: values };
    }

    function applyDraftState(state) {
        if (!state) return;
        var values = state.values || state;
        if (!values || typeof values !== 'object') return;
        Object.keys(values).forEach(function(name) {
            if (name === '__activeTab') return;
            var selector = '[name="' + escapeSelector(name) + '"]';
            var $els = $(selector);
            if (!$els.length) return;
            var type = ($els.attr('type') || '').toLowerCase();
            var value = values[name];
            if (type === 'checkbox') {
                $els.prop('checked', !!value);
                return;
            }
            if (type === 'radio') {
                $els.filter('[value="' + value + '"]').prop('checked', true);
                return;
            }
            if ($els.is('select[multiple]')) {
                $els.val(Array.isArray(value) ? value : []).trigger('change');
                return;
            }
            $els.val(value);
        });
        if (values.custom_rules && editor) {
            editor.setValue(values.custom_rules);
        }
        if (values.__activeTab) {
            var $tab = $('#aacr2-config-tabs a[href="' + values.__activeTab + '"]');
            if ($tab.length) $tab.trigger('click');
        }
    }

    function saveDraftSoon() {
        if (draftTimer) clearTimeout(draftTimer);
        draftTimer = setTimeout(function() {
            try {
                var snapshot = collectDraftState();
                sessionStorage.setItem(draftKey, JSON.stringify(snapshot));
            } catch (err) {
                // ignore storage failures
            }
        }, 150);
    }

    function loadDraftState() {
        try {
            var raw = sessionStorage.getItem(draftKey);
            return raw ? JSON.parse(raw) : null;
        } catch (err) {
            return null;
        }
    }

    function clearDraftState() {
        try {
            sessionStorage.removeItem(draftKey);
        } catch (err) {
            // ignore storage failures
        }
    }

    // Toggle select all checkboxes
    function toggleSelectAll(className, checked) {
        $('input[type="checkbox"][name="' + className + '"]').prop('checked', checked);
    }

    // Toggle user checkboxes based on mode enable checkbox
    function toggleUserCheckboxes() {
        var isGuideEnabled = $('#enable_guide').is(':checked');
        var isInternshipEnabled = $('#internship_mode').is(':checked');

        $('input[name="guide_users"]')
            .prop('disabled', !isGuideEnabled)
            .toggleClass('disabled-checkbox', !isGuideEnabled);
        $('input[name="internship_users"]')
            .prop('disabled', !isInternshipEnabled)
            .toggleClass('disabled-checkbox', !isInternshipEnabled);
        $('#selectAllGuideUsers')
            .prop('disabled', !isGuideEnabled)
            .toggleClass('disabled-checkbox', !isGuideEnabled);
        $('#selectAllInternshipUsers')
            .prop('disabled', !isInternshipEnabled)
            .toggleClass('disabled-checkbox', !isInternshipEnabled);
        $('.internship-access-control')
            .prop('disabled', !isInternshipEnabled)
            .toggleClass('disabled-checkbox', !isInternshipEnabled);

        if (!isGuideEnabled) {
            $('input[name="guide_users"]').prop('checked', false);
            $('#selectAllGuideUsers').prop('checked', false);
        }

        if (!isInternshipEnabled) {
            $('input[name="internship_users"]').prop('checked', false);
            $('#selectAllInternshipUsers').prop('checked', false);
        }
    }

    function normalizeText(value) {
        return (value || '').toString().toLowerCase();
    }

    function filterUserTableRows(inputSelector, filterSelector, tableSelector) {
        var query = normalizeText($(inputSelector).val());
        var filter = $(filterSelector).val() || 'all';
        $(tableSelector).find('tbody tr').each(function() {
            var text = normalizeText($(this).text());
            var checked = $(this).find('input[type="checkbox"]').is(':checked');
            var matchesQuery = !query || text.indexOf(query) !== -1;
            var matchesFilter = filter === 'all' || (filter === 'selected' && checked) || (filter === 'unselected' && !checked);
            $(this).toggle(matchesQuery && matchesFilter);
        });
    }

    function sortTableRows(tableSelector, columnIndex, asc) {
        var $tbody = $(tableSelector).find('tbody');
        var rows = $tbody.find('tr').get();
        var cellComparable = function($cell) {
            if (!$cell || !$cell.length) return { type: 'text', value: '' };
            var sortValue = $cell.attr('data-sort-value');
            if (sortValue !== undefined) {
                var parsedSort = Number(sortValue);
                if (isFinite(parsedSort)) return { type: 'number', value: parsedSort };
                return { type: 'text', value: normalizeText(sortValue) };
            }
            var text = ($cell.text() || '').trim();
            var numericText = text.match(/^(-?\d+(?:\.\d+)?)(?:%|\b)/);
            if (numericText) {
                var parsed = Number(numericText[1]);
                if (isFinite(parsed)) return { type: 'number', value: parsed };
            }
            return { type: 'text', value: normalizeText(text) };
        };
        rows.sort(function(a, b) {
            var valueA = cellComparable($(a).children('td').eq(columnIndex));
            var valueB = cellComparable($(b).children('td').eq(columnIndex));
            if (valueA.type === 'number' && valueB.type === 'number') {
                if (valueA.value < valueB.value) return asc ? -1 : 1;
                if (valueA.value > valueB.value) return asc ? 1 : -1;
                return 0;
            }
            if (valueA.value < valueB.value) return asc ? -1 : 1;
            if (valueA.value > valueB.value) return asc ? 1 : -1;
            return 0;
        });
        $.each(rows, function(index, row) { $tbody.append(row); });
    }

    function sortableColumnIndex(tableSelector, sortField) {
        var wanted = normalizeText(sortField || '');
        if (!wanted) return -1;
        var index = -1;
        $(tableSelector).find('th.sortable').each(function() {
            if (normalizeText($(this).attr('data-sort') || '') === wanted) {
                index = $(this).index();
                return false;
            }
            return true;
        });
        return index;
    }

    function sortTableByField(tableSelector, sortField, direction) {
        var index = sortableColumnIndex(tableSelector, sortField);
        if (index < 0) return;
        var asc = normalizeText(direction) !== 'desc';
        sortTableRows(tableSelector, index, asc);
        var $table = $(tableSelector);
        $table.find('th.sortable').removeClass('sort-asc sort-desc');
        $table.find('thead th').eq(index).addClass(asc ? 'sort-asc' : 'sort-desc');
    }

    function setupSortableTable(tableSelector) {
        var $table = $(tableSelector);
        if ($table.data('aacr2SortBound')) return;
        $table.data('aacr2SortBound', 1);
        var sortState = {};
        $table.find('th.sortable').each(function() {
            var columnIndex = $(this).index();
            $(this).on('click', function() {
                sortState[columnIndex] = !sortState[columnIndex];
                sortTableRows(tableSelector, columnIndex, sortState[columnIndex]);
                $table.find('th.sortable').removeClass('sort-asc sort-desc');
                $(this).addClass(sortState[columnIndex] ? 'sort-asc' : 'sort-desc');
            });
        });
    }

    function progressStatusFromCounts(total, done, updatedAt) {
        total = Number(total || 0);
        done = Number(done || 0);
        if (!total && !done) {
            return 'not_started';
        }
        if (!total) return 'in_progress';
        if (!done) return 'not_started';
        if (done >= total) return 'completed';
        return 'in_progress';
    }

    function formatTimestamp(epoch) {
        if (!epoch) return '';
        var date = new Date(epoch * 1000);
        return date.toLocaleString();
    }

    function escapeHtml(value) {
        return (value === undefined || value === null ? '' : String(value))
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function fallbackCurrentModule(summary) {
        summary = summary || {};
        var modules = summary.module_breakdown || {};
        var names = Object.keys(modules);
        if (!names.length) return '';
        var nextModule = names[0] || '';
        names.some(function(name) {
            var entry = modules[name] || {};
            var done = Number(entry.completed || 0) + Number(entry.skipped || 0);
            if (Number(entry.total || 0) > 0 && done < Number(entry.total || 0)) {
                nextModule = name;
                return true;
            }
            return false;
        });
        return nextModule || '';
    }

    function completionTierFromPercent(percent) {
        var value = Number(percent);
        if (!isFinite(value)) value = 0;
        value = Math.round(value);
        if (value < 0) value = 0;
        if (value > 100) value = 100;
        if (value <= 33) return 'Tier 1';
        if (value <= 66) return 'Tier 2';
        return 'Tier 3';
    }

    function fallbackCurrentTier(summary, summaryCounts) {
        summary = summary || {};
        var completion = Number(summary.completion_percent);
        if (!isFinite(completion)) {
            var counts = overallCountsFromSummary(summary, summaryCounts || summary);
            if (counts.total > 0) {
                completion = Math.round(((counts.completed + counts.skipped) / counts.total) * 100);
            } else {
                completion = 0;
            }
        }
        return completionTierFromPercent(completion);
    }

    function summarizeProgressRow(done, total, percentOverride) {
        done = Number(done || 0);
        total = Number(total || 0);
        var percent = Number(percentOverride);
        if (!isFinite(percent)) {
            if (!total) return '0%';
            percent = Math.round((done / total) * 100);
        } else {
            percent = Math.round(percent);
        }
        if (percent < 0) percent = 0;
        if (percent > 100) percent = 100;
        if (!total) return percent + '%';
        return percent + '% (' + done + '/' + total + ')';
    }

    function moduleCountsFromSummary(summary, summaryCounts, moduleName) {
        summary = summary || {};
        summaryCounts = summaryCounts || {};
        var breakdown = summary.module_breakdown || {};
        var moduleLabel = moduleName || '';
        var entry = moduleLabel && breakdown[moduleLabel] ? breakdown[moduleLabel] : null;
        if (!entry && moduleLabel) {
            var wanted = normalizeText(moduleLabel);
            Object.keys(breakdown).some(function(key) {
                if (normalizeText(key) === wanted) {
                    entry = breakdown[key];
                    return true;
                }
                return false;
            });
        }

        var completed;
        var skipped;
        var total;
        if (entry && typeof entry === 'object') {
            completed = Number(entry.completed || 0);
            skipped = Number(entry.skipped || 0);
            total = Number(entry.total || 0);
        } else {
            completed = Number(summaryCounts.completed_count || summaryCounts.steps_completed || 0);
            skipped = Number(summaryCounts.skipped_count || summaryCounts.steps_skipped || 0);
            total = Number(summaryCounts.total || summaryCounts.steps_total || 0);
        }

        if (completed < 0) completed = 0;
        if (skipped < 0) skipped = 0;
        if (total < 0) total = 0;
        if (total < (completed + skipped)) {
            total = completed + skipped;
        }

        return {
            completed: completed,
            skipped: skipped,
            total: total
        };
    }

    function overallCountsFromSummary(summary, summaryCounts) {
        summary = summary || {};
        summaryCounts = summaryCounts || {};
        var completed = Number(
            summary.completed_count
            || summary.steps_completed
            || summaryCounts.completed_count
            || summaryCounts.steps_completed
            || 0
        );
        var skipped = Number(
            summary.skipped_count
            || summary.steps_skipped
            || summaryCounts.skipped_count
            || summaryCounts.steps_skipped
            || 0
        );
        var total = Number(
            summary.total
            || summary.steps_total
            || summaryCounts.total
            || summaryCounts.steps_total
            || 0
        );

        if (completed < 0) completed = 0;
        if (skipped < 0) skipped = 0;
        if (total < 0) total = 0;
        if (total < (completed + skipped)) {
            total = completed + skipped;
        }

        return {
            completed: completed,
            skipped: skipped,
            total: total
        };
    }

    function sortTierLabels(list) {
        return (list || []).sort(function(a, b) {
            var aa = (a || '').toString();
            var bb = (b || '').toString();
            var na = parseInt((aa.match(/\d+/) || [999])[0], 10);
            var nb = parseInt((bb.match(/\d+/) || [999])[0], 10);
            if (na !== nb) return na - nb;
            return aa.localeCompare(bb);
        });
    }

    function updateProgressFilterOptions(rows) {
        rows = rows || [];
        var modules = [];
        var tiers = [];
        rows.forEach(function(row) {
            if (row.module && modules.indexOf(row.module) === -1) modules.push(row.module);
            if (row.tier && tiers.indexOf(row.tier) === -1) tiers.push(row.tier);
        });
        modules.sort(function(a, b) { return a.localeCompare(b); });
        tiers = sortTierLabels(tiers);

        var applyOptions = function($select, values, allLabel) {
            var previous = $select.val() || 'all';
            $select.empty();
            $select.append($('<option>').val('all').text(allLabel));
            values.forEach(function(value) {
                $select.append($('<option>').val(value).text(value));
            });
            if (previous !== 'all') {
                var matched = values.filter(function(value) {
                    return normalizeText(value) === normalizeText(previous);
                })[0];
                $select.val(matched || 'all');
            } else {
                $select.val('all');
            }
        };

        applyOptions($('#progress-tier-filter'), tiers, 'All tiers');
        applyOptions($('#progress-module-filter'), modules, 'All modules');
    }

    function renderProgressTable(rows) {
        var $tbody = $('#aacr2-progress-table tbody');
        $tbody.empty();
        if (!rows || !rows.length) {
            $tbody.append('<tr><td colspan="10">No progress records yet.</td></tr>');
            updateProgressFilterOptions([]);
            return;
        }
        var filterRows = [];
        rows.forEach(function(row) {
            var summaryCounts = row.summary_counts || row.summary || {};
            var summary = row.summary || {};
            var moduleSummary = summary.current_module || fallbackCurrentModule(summary) || 'n/a';
            var tierSummary = fallbackCurrentTier(summary, summaryCounts) || 'Tier 1';
            var moduleCounts = moduleCountsFromSummary(summary, summaryCounts, moduleSummary);
            var overallCounts = overallCountsFromSummary(summary, summaryCounts);
            var overallDone = overallCounts.completed + overallCounts.skipped;
            var completionPercent = Number(summary.completion_percent);
            if (!isFinite(completionPercent) && overallCounts.total > 0) {
                completionPercent = Math.round((overallDone / overallCounts.total) * 100);
            }
            var status = progressStatusFromCounts(overallCounts.total, overallDone, row.updated_at);
            var summaryText = summarizeProgressRow(overallDone, overallCounts.total, completionPercent);
            var completionSort = Number(completionPercent);
            if (!isFinite(completionSort)) completionSort = 0;
            filterRows.push({
                module: moduleSummary,
                tier: tierSummary
            });
            var $tr = $('<tr>')
                .attr('data-status', status)
                .attr('data-tier', normalizeText(tierSummary))
                .attr('data-module', normalizeText(moduleSummary))
                .append('<td>' + escapeHtml(row.userid || '') + '</td>')
                .append('<td>' + escapeHtml(row.name || '') + '</td>')
                .append('<td>' + escapeHtml(tierSummary) + '</td>')
                .append('<td>' + escapeHtml(moduleSummary) + '</td>')
                .append('<td data-sort-value="' + moduleCounts.completed + '">' + moduleCounts.completed + '</td>')
                .append('<td data-sort-value="' + moduleCounts.skipped + '">' + moduleCounts.skipped + '</td>')
                .append('<td data-sort-value="' + overallCounts.completed + '">' + overallCounts.completed + '</td>')
                .append('<td data-sort-value="' + overallCounts.skipped + '">' + overallCounts.skipped + '</td>')
                .append('<td data-sort-value="' + completionSort + '">' + escapeHtml(summaryText) + '</td>')
                .append('<td data-sort-value="' + Number(row.updated_at || 0) + '">' + formatTimestamp(row.updated_at) + '</td>');
            $tbody.append($tr);
        });
        updateProgressFilterOptions(filterRows);
    }

    function applyProgressFilters() {
        var query = normalizeText($('#progress-search').val());
        var status = normalizeText($('#progress-status-filter').val() || 'all');
        var tier = normalizeText($('#progress-tier-filter').val() || 'all');
        var module = normalizeText($('#progress-module-filter').val() || 'all');
        $('#aacr2-progress-table tbody tr').each(function() {
            var rowText = normalizeText($(this).text());
            var rowStatus = normalizeText($(this).attr('data-status') || '');
            var rowTier = normalizeText($(this).attr('data-tier') || '');
            var rowModule = normalizeText($(this).attr('data-module') || '');
            var matchesQuery = !query || rowText.indexOf(query) !== -1;
            var matchesStatus = status === 'all' || status === rowStatus;
            var matchesTier = tier === 'all' || tier === rowTier;
            var matchesModule = module === 'all' || module === rowModule;
            $(this).toggle(matchesQuery && matchesStatus && matchesTier && matchesModule);
        });
    }

    function currentTableSortState(tableSelector, fallbackField, fallbackDirection) {
        var field = fallbackField || 'updated_at';
        var direction = fallbackDirection || 'desc';
        $(tableSelector).find('th.sortable').each(function() {
            var $th = $(this);
            if ($th.hasClass('sort-asc') || $th.hasClass('sort-desc')) {
                field = ($th.attr('data-sort') || field);
                direction = $th.hasClass('sort-asc') ? 'asc' : 'desc';
                return false;
            }
            return true;
        });
        return { field: field, direction: direction };
    }

    function applyProgressSort() {
        var state = currentTableSortState('#aacr2-progress-table', 'updated_at', 'desc');
        sortTableByField('#aacr2-progress-table', state.field, state.direction);
    }

    function getVisibleProgressRowsForExport() {
        var rows = [];
        $('#aacr2-progress-table tbody tr:visible').each(function() {
            var cells = $(this).children('td');
            if (!cells.length || cells.length < 10) return;
            rows.push([
                $(cells[0]).text().trim(),
                $(cells[1]).text().trim(),
                $(cells[2]).text().trim(),
                $(cells[3]).text().trim(),
                $(cells[4]).text().trim(),
                $(cells[5]).text().trim(),
                $(cells[6]).text().trim(),
                $(cells[7]).text().trim(),
                $(cells[8]).text().trim(),
                $(cells[9]).text().trim()
            ]);
        });
        return rows;
    }

    function downloadBlob(filename, type, content) {
        var blob = new Blob([content], { type: type });
        var url = URL.createObjectURL(blob);
        var link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(function() { URL.revokeObjectURL(url); }, 500);
    }

    function exportProgressAsCsv() {
        var rows = getVisibleProgressRowsForExport();
        if (!rows.length) {
            toastr.warning('No visible progress rows to export.');
            return;
        }
        var headers = ['User ID', 'Name', 'Tier', 'Module', 'Module Steps Done', 'Module Steps Skipped', 'Total Steps Done', 'Total Steps Skipped', 'Completion Progress', 'Last Updated'];
        var esc = function(value) {
            var text = (value === undefined || value === null) ? '' : String(value);
            return '"' + text.replace(/"/g, '""') + '"';
        };
        var lines = [headers.map(esc).join(',')];
        rows.forEach(function(row) {
            lines.push(row.map(esc).join(','));
        });
        var stamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
        downloadBlob('aacr2-training-progress-' + stamp + '.csv', 'text/csv;charset=utf-8', '\ufeff' + lines.join('\n'));
    }

    function buildXlsxWorkbookBytes(headers, rows) {
        var xmlEscape = function(value) {
            return (value === undefined || value === null ? '' : String(value))
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        };
        var utf8 = function(text) {
            if (window.TextEncoder) return new TextEncoder().encode(text);
            var encoded = unescape(encodeURIComponent(text));
            var out = new Uint8Array(encoded.length);
            for (var i = 0; i < encoded.length; i++) out[i] = encoded.charCodeAt(i);
            return out;
        };
        var toColumnName = function(index) {
            var n = index + 1;
            var result = '';
            while (n > 0) {
                var mod = (n - 1) % 26;
                result = String.fromCharCode(65 + mod) + result;
                n = Math.floor((n - 1) / 26);
            }
            return result;
        };
        var allRows = [headers].concat(rows || []);
        var lastCol = toColumnName(Math.max(headers.length - 1, 0));
        var lastRow = Math.max(allRows.length, 1);
        var sheetRows = allRows.map(function(row, rowIndex) {
            var rowNumber = rowIndex + 1;
            var cells = (row || []).map(function(cell, colIndex) {
                var ref = toColumnName(colIndex) + rowNumber;
                var text = cell === undefined || cell === null ? '' : String(cell);
                var preserve = (/^\s|\s$|\n/.test(text)) ? ' xml:space="preserve"' : '';
                return '<c r="' + ref + '" t="inlineStr"><is><t' + preserve + '>' + xmlEscape(text) + '</t></is></c>';
            }).join('');
            return '<row r="' + rowNumber + '">' + cells + '</row>';
        }).join('');

        var contentTypes = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>'
            + '<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">'
            + '<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>'
            + '<Default Extension="xml" ContentType="application/xml"/>'
            + '<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>'
            + '<Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>'
            + '<Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/>'
            + '</Types>';
        var rels = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>'
            + '<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">'
            + '<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>'
            + '</Relationships>';
        var workbook = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>'
            + '<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" '
            + 'xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">'
            + '<sheets><sheet name="Progress" sheetId="1" r:id="rId1"/></sheets>'
            + '</workbook>';
        var workbookRels = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>'
            + '<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">'
            + '<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>'
            + '<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>'
            + '</Relationships>';
        var worksheet = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>'
            + '<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">'
            + '<dimension ref="A1:' + lastCol + lastRow + '"/>'
            + '<sheetData>' + sheetRows + '</sheetData>'
            + '</worksheet>';
        var styles = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>'
            + '<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">'
            + '<fonts count="1"><font><sz val="11"/><name val="Calibri"/><family val="2"/></font></fonts>'
            + '<fills count="2"><fill><patternFill patternType="none"/></fill><fill><patternFill patternType="gray125"/></fill></fills>'
            + '<borders count="1"><border><left/><right/><top/><bottom/><diagonal/></border></borders>'
            + '<cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>'
            + '<cellXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/></cellXfs>'
            + '<cellStyles count="1"><cellStyle name="Normal" xfId="0" builtinId="0"/></cellStyles>'
            + '</styleSheet>';

        var files = [
            { name: '[Content_Types].xml', data: utf8(contentTypes) },
            { name: '_rels/.rels', data: utf8(rels) },
            { name: 'xl/workbook.xml', data: utf8(workbook) },
            { name: 'xl/_rels/workbook.xml.rels', data: utf8(workbookRels) },
            { name: 'xl/worksheets/sheet1.xml', data: utf8(worksheet) },
            { name: 'xl/styles.xml', data: utf8(styles) }
        ];

        var crcTable = (function() {
            var table = new Uint32Array(256);
            for (var n = 0; n < 256; n++) {
                var c = n;
                for (var k = 0; k < 8; k++) {
                    c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
                }
                table[n] = c >>> 0;
            }
            return table;
        })();
        var crc32 = function(bytes) {
            var c = 0xFFFFFFFF;
            for (var i = 0; i < bytes.length; i++) {
                c = crcTable[(c ^ bytes[i]) & 0xFF] ^ (c >>> 8);
            }
            return (c ^ 0xFFFFFFFF) >>> 0;
        };
        var push16 = function(arr, value) {
            arr.push(value & 255, (value >>> 8) & 255);
        };
        var push32 = function(arr, value) {
            arr.push(value & 255, (value >>> 8) & 255, (value >>> 16) & 255, (value >>> 24) & 255);
        };
        var concatChunks = function(chunks) {
            var total = chunks.reduce(function(sum, chunk) { return sum + chunk.length; }, 0);
            var out = new Uint8Array(total);
            var offset = 0;
            chunks.forEach(function(chunk) {
                out.set(chunk, offset);
                offset += chunk.length;
            });
            return out;
        };
        var now = new Date();
        var dosTime = ((now.getHours() & 31) << 11) | ((now.getMinutes() & 63) << 5) | ((Math.floor(now.getSeconds() / 2)) & 31);
        var year = now.getFullYear() < 1980 ? 1980 : now.getFullYear();
        var dosDate = (((year - 1980) & 127) << 9) | (((now.getMonth() + 1) & 15) << 5) | (now.getDate() & 31);

        var localChunks = [];
        var centralChunks = [];
        var offset = 0;
        files.forEach(function(file) {
            var nameBytes = utf8(file.name);
            var dataBytes = file.data;
            var checksum = crc32(dataBytes);

            var localHeader = [];
            push32(localHeader, 0x04034b50);
            push16(localHeader, 20);
            push16(localHeader, 0);
            push16(localHeader, 0);
            push16(localHeader, dosTime);
            push16(localHeader, dosDate);
            push32(localHeader, checksum);
            push32(localHeader, dataBytes.length);
            push32(localHeader, dataBytes.length);
            push16(localHeader, nameBytes.length);
            push16(localHeader, 0);
            localChunks.push(new Uint8Array(localHeader), nameBytes, dataBytes);

            var centralHeader = [];
            push32(centralHeader, 0x02014b50);
            push16(centralHeader, 20);
            push16(centralHeader, 20);
            push16(centralHeader, 0);
            push16(centralHeader, 0);
            push16(centralHeader, dosTime);
            push16(centralHeader, dosDate);
            push32(centralHeader, checksum);
            push32(centralHeader, dataBytes.length);
            push32(centralHeader, dataBytes.length);
            push16(centralHeader, nameBytes.length);
            push16(centralHeader, 0);
            push16(centralHeader, 0);
            push16(centralHeader, 0);
            push16(centralHeader, 0);
            push32(centralHeader, 0);
            push32(centralHeader, offset);
            centralChunks.push(new Uint8Array(centralHeader), nameBytes);

            offset += localHeader.length + nameBytes.length + dataBytes.length;
        });

        var centralBytes = concatChunks(centralChunks);
        var localBytes = concatChunks(localChunks);
        var eocd = [];
        push32(eocd, 0x06054b50);
        push16(eocd, 0);
        push16(eocd, 0);
        push16(eocd, files.length);
        push16(eocd, files.length);
        push32(eocd, centralBytes.length);
        push32(eocd, localBytes.length);
        push16(eocd, 0);
        return concatChunks([localBytes, centralBytes, new Uint8Array(eocd)]);
    }

    function exportProgressAsExcel() {
        var rows = getVisibleProgressRowsForExport();
        if (!rows.length) {
            toastr.warning('No visible progress rows to export.');
            return;
        }
        var headers = ['User ID', 'Name', 'Tier', 'Module', 'Module Steps Done', 'Module Steps Skipped', 'Total Steps Done', 'Total Steps Skipped', 'Completion Progress', 'Last Updated'];
        var stamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
        try {
            var xlsxBytes = buildXlsxWorkbookBytes(headers, rows);
            downloadBlob(
                'aacr2-training-progress-' + stamp + '.xlsx',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                xlsxBytes
            );
        } catch (err) {
            toastr.error('Excel export failed: ' + (err && err.message ? err.message : 'unknown error'));
        }
    }

    function sanitizeServerMessage(text) {
        return (text || '')
            .toString()
            .replace(/<[^>]*>/g, ' ')
            .replace(/\s+/g, ' ')
            .trim()
            .slice(0, 180);
    }

    function buildHttpError(status, message) {
        var detail = (message || '').toString().trim();
        return 'HTTP ' + status + (detail ? ': ' + detail : '');
    }

    function sessionExpiredMessage(status) {
        return (status === 401)
            ? 'Session expired. Please refresh and log in again.'
            : '';
    }

    function normalizeVersionParts(version) {
        var text = (version || '').toString();
        text = text.replace(/^[^0-9]*/, '');
        if (!text) return [0];
        return text.split('.').map(function(part) {
            var cleaned = (part || '').toString().replace(/[^0-9].*$/, '');
            var n = parseInt(cleaned || '0', 10);
            return isFinite(n) ? n : 0;
        });
    }

    function compareVersionStrings(current, latest) {
        var a = normalizeVersionParts(current);
        var b = normalizeVersionParts(latest);
        var max = Math.max(a.length, b.length);
        for (var i = 0; i < max; i++) {
            var av = a[i] || 0;
            var bv = b[i] || 0;
            if (av < bv) return -1;
            if (av > bv) return 1;
        }
        return 0;
    }

    function renderBrowserReleaseAlert(latestVersion, releaseUrl) {
        if (!latestVersion) return;
        if ($('#aacr2-update-alert').length) return;
        var current = '[% current_version %]';
        var safeUrl = releaseUrl || '[% plugin_repo_url %]';
        var html = ''
            + '<div class="alert alert-warning" id="aacr2-update-alert">'
            + '<p><i class="fa fa-exclamation-circle"></i> New release available: '
            + escapeHtml(latestVersion) + ' (current ' + escapeHtml(current) + ').</p>'
            + '<p><a href="' + escapeHtml(safeUrl) + '" target="_blank" rel="noopener">View release on GitHub</a></p>'
            + '</div>';
        $('.main .row .col-sm-10 main h1').first().after(html);
    }

    function checkBrowserReleaseNotification() {
        var apiUrl = '[% plugin_releases_api %]';
        if (!apiUrl) return;
        fetch(apiUrl, {
            method: 'GET',
            headers: { 'Accept': 'application/vnd.github+json' }
        })
            .then(function(response) {
                if (!response.ok) return null;
                return response.json();
            })
            .then(function(data) {
                if (!data || typeof data !== 'object') return;
                var latest = (data.tag_name || data.name || '').toString().trim();
                if (!latest) return;
                if (compareVersionStrings('[% current_version %]', latest) >= 0) return;
                renderBrowserReleaseAlert(latest, data.html_url || '[% plugin_repo_url %]');
            })
            .catch(function() {
                // Keep UI quiet on release-check network failures.
            });
    }

    function looksLikeKohaLoginHtml(text) {
        var raw = (text || '').toString().toLowerCase();
        return raw.indexOf('name="login_userid"') !== -1
            || raw.indexOf('id="loginform"') !== -1
            || raw.indexOf('koha login') !== -1
            || raw.indexOf('auth.tt') !== -1;
    }

    function getCsrfToken() {
        function normalizeToken(value) {
            if (value === undefined || value === null) return '';
            var token = String(value).replace(/[\r\n]/g, '').trim();
            if (!token) return '';
            if (token.indexOf(',') !== -1) {
                token = token.split(',').map(function(item) { return item.trim(); }).filter(Boolean)[0] || '';
            }
            return token;
        }
        function isPluginToken(value) {
            return /^[a-f0-9]{64}$/i.test(String(value || '').trim());
        }
        var token = '';
        var $pluginForm = $('form[data-plugin-csrf-token]').first();
        if ($pluginForm.length) {
            token = normalizeToken($pluginForm.attr('data-plugin-csrf-token') || '');
            if (token && !isPluginToken(token)) token = '';
        }
        if (!token) {
            var $pluginField = $('form[data-plugin-csrf-token] input[name="csrf_token"]').first();
            token = normalizeToken($pluginField.length ? ($pluginField.val() || '') : '');
            if (token && !isPluginToken(token)) token = '';
        }
        if (!token) {
            var $field = $('#csrf_token');
            token = normalizeToken($field.length ? ($field.val() || '') : '');
            if (token && !isPluginToken(token)) token = '';
        }
        if (!token) {
            var pluginMeta = document.querySelector('meta[name="aacr2-plugin-csrf-token"]');
            token = normalizeToken(pluginMeta ? pluginMeta.getAttribute('content') : '');
            if (token && !isPluginToken(token)) token = '';
        }
        if (!token) {
            var metas = document.querySelectorAll('meta[name="csrf-token"]');
            for (var i = 0; i < metas.length; i += 1) {
                token = normalizeToken(metas[i] ? metas[i].getAttribute('content') : '');
                if (token && !isPluginToken(token)) {
                    token = '';
                    continue;
                }
                if (token) break;
            }
        }
        return token;
    }

    function fetchJson(url, options) {
        var opts = options || {};
        opts.credentials = 'include';
        return fetch(url, opts).then(function(response) {
            var contentType = (response.headers.get('content-type') || '').toLowerCase();
            var isJson = contentType.indexOf('application/json') !== -1;
            if (!response.ok) {
                var sessionMessage = sessionExpiredMessage(response.status);
                if (sessionMessage) {
                    throw new Error(buildHttpError(response.status, sessionMessage));
                }
                if (isJson) {
                    return response.json().then(function(data) {
                        var message = (data && (data.error || data.message)) || '';
                        if (!message && data && data.details) {
                            message = JSON.stringify(data.details);
                        }
                        throw new Error(buildHttpError(response.status, message || 'Request failed.'));
                    }, function() {
                        return response.text().then(function(text) {
                            if (looksLikeKohaLoginHtml(text)) {
                                throw new Error(buildHttpError(response.status, 'Session expired. Please refresh and log in again.'));
                            }
                            var message = sanitizeServerMessage(text) || 'Request failed.';
                            throw new Error(buildHttpError(response.status, message));
                        });
                    });
                }
                return response.text().then(function(text) {
                    if (looksLikeKohaLoginHtml(text)) {
                        throw new Error(buildHttpError(response.status, 'Session expired. Please refresh and log in again.'));
                    }
                    var message = sanitizeServerMessage(text) || 'Request failed.';
                    throw new Error(buildHttpError(response.status, message));
                });
            }
            if (!isJson) {
                return response.text().then(function(text) {
                    if (looksLikeKohaLoginHtml(text)) {
                        throw new Error(buildHttpError(401, 'Session expired. Please refresh and log in again.'));
                    }
                    var message = sanitizeServerMessage(text) || 'Non-JSON response from server.';
                    throw new Error(buildHttpError(response.status, message));
                });
            }
            return response.json().then(function(data) {
                return data;
            }, function() {
                return response.text().then(function(text) {
                    var message = sanitizeServerMessage(text) || 'Response was not valid JSON.';
                    throw new Error(buildHttpError(response.status, message));
                });
            });
        });
    }

    function buildPluginMethodUrl(pluginPath, methodName, extraParams) {
        var method = (methodName || '').toString().trim();
        if (!method) {
            throw new Error('Plugin method is required.');
        }
        var fallbackClass = '[% CLASS %]';
        var basePath = '/cgi-bin/koha/plugins/run.pl';
        var className = fallbackClass;
        var rawPath = (pluginPath || '').toString();

        if (rawPath) {
            var qm = rawPath.indexOf('?');
            if (qm >= 0) {
                basePath = rawPath.substring(0, qm) || basePath;
                var query = rawPath.substring(qm + 1);
                var parsed = new URLSearchParams(query || '');
                className = (parsed.get('class') || className || '').trim();
            } else if (rawPath.indexOf('/cgi-bin/koha/plugins/run.pl') !== -1) {
                basePath = rawPath;
            }
        }

        var params = new URLSearchParams();
        if (className) params.set('class', className);
        params.set('method', method);
        if (extraParams && typeof extraParams === 'object') {
            Object.keys(extraParams).forEach(function(key) {
                var value = extraParams[key];
                if (value === undefined || value === null || value === '') return;
                params.set(key, String(value));
            });
        }
        return basePath + '?' + params.toString();
    }

    function postPluginJson(pluginPath, methodName, payload, extraParams) {
        var csrfToken = getCsrfToken();
        var finalPayload = (payload && typeof payload === 'object') ? $.extend({}, payload) : {};
        var params = $.extend({ op: 'plugin_api' }, extraParams || {});
        var url = buildPluginMethodUrl(pluginPath, methodName, params);
        var headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };
        if (csrfToken) {
            headers['X-CSRF-Token'] = csrfToken;
            headers['CSRF-TOKEN'] = csrfToken;
        }
        if (csrfToken && !finalPayload.csrf_token) finalPayload.csrf_token = csrfToken;
        return fetchJson(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(finalPayload)
        });
    }

    var progressFetchController = null;
    var isConfigurationSubmitInProgress = false;
    var isConfigurePageUnloading = false;

    function shouldIgnoreProgressLoadError(err) {
        if (isConfigurationSubmitInProgress || isConfigurePageUnloading) return true;
        var name = ((err && err.name) || '').toString().toLowerCase();
        var message = ((err && err.message) || '').toString().toLowerCase();
        if (name === 'aborterror') return true;
        if (message.indexOf('aborted') !== -1 || message.indexOf('abort') !== -1) return true;
        if ((name === 'typeerror' || name === 'error') && message.indexOf('networkerror when attempting to fetch resource') !== -1) {
            return true;
        }
        return false;
    }

    function fetchProgressTable(pluginPath) {
        if (isConfigurePageUnloading) return;
        if (progressFetchController) {
            try { progressFetchController.abort(); } catch (abortErr) { /* ignore */ }
        }
        var controller = (window.AbortController ? new AbortController() : null);
        progressFetchController = controller;
        fetchJson(buildPluginMethodUrl(pluginPath, 'guide_progress_list', { op: 'plugin_api' }), {
            method: 'GET',
            headers: { 'Accept': 'application/json' },
            signal: controller ? controller.signal : undefined
        })
            .then(function(data) {
                if (isConfigurePageUnloading || isConfigurationSubmitInProgress) return;
                renderProgressTable((data && data.users) || []);
                setupSortableTable('#aacr2-progress-table');
                applyProgressSort();
                applyProgressFilters();
            })
            .catch(function(err) {
                if (shouldIgnoreProgressLoadError(err)) return;
                toastr.error('Progress load failed: ' + err.message);
                $('#aacr2-progress-table tbody').html('<tr><td colspan="10">Unable to load progress.</td></tr>');
                updateProgressFilterOptions([]);
            })
            .finally(function() {
                if (progressFetchController === controller) {
                    progressFetchController = null;
                }
            });
    }

    // Document ready function
    $(document).ready(function() {
        var savedSuccessfully = [% saved_successfully ? 1 : 0 %];
        draftState = loadDraftState();
        var pluginPath = '/cgi-bin/koha/plugins/run.pl?class=' + encodeURIComponent('[% CLASS %]');
        var csrfValue = getCsrfToken();
        var $form = $('form[data-plugin-csrf-token]').first();
        if ($form.length && csrfValue) {
            $form.attr('data-plugin-csrf-token', csrfValue);
        }
        if (csrfValue && $('#csrf_token').length && !$('#csrf_token').val()) {
            $('#csrf_token').val(csrfValue);
        }
        // Release checks already run server-side; avoid browser cross-origin noise.
        $(window).on('beforeunload pagehide', function() {
            isConfigurePageUnloading = true;
            if (progressFetchController) {
                try { progressFetchController.abort(); } catch (err) { /* ignore */ }
            }
        });
        var tabEls = document.querySelectorAll('#aacr2-config-tabs a[data-bs-toggle="tab"]');
        if (window.bootstrap && window.bootstrap.Tab) {
            tabEls.forEach(function(tabEl) {
                tabEl.addEventListener('click', function(event) {
                    event.preventDefault();
                    window.bootstrap.Tab.getOrCreateInstance(tabEl).show();
                });
            });
        } else {
            $('#aacr2-config-tabs a').on('click', function(event) {
                event.preventDefault();
                $('#aacr2-config-tabs .nav-link').removeClass('active');
                $(this).addClass('active');
                $('.tab-pane').removeClass('show active');
                var target = $(this).attr('href') || $(this).data('bs-target');
                if (target) $(target).addClass('show active');
            });
        }
        // Initialize Select2 for multi-select dropdowns when available
        if ($.fn && $.fn.select2) {
            $('#guide_users, #internship_users').select2({
                placeholder: "Select option",
                allowClear: true,
                width: '100%'
            });
            $('#llm_api_provider').select2({
                minimumResultsForSearch: Infinity,
                width: 'style',
                dropdownAutoWidth: true,
                dropdownParent: $('#llm_api_provider').closest('li')
            });
            $('#ai_model').select2({
                placeholder: 'Select a model',
                allowClear: true,
                width: 'style'
            });
        }

        if (savedSuccessfully) {
            clearDraftState();
        } else if (draftState) {
            applyDraftState(draftState);
        }

        // Toggle user checkboxes based on initial state
        toggleUserCheckboxes();

        // Event handlers for enabling/disabling user checkboxes
        $('#enable_guide').change(toggleUserCheckboxes);
        $('#internship_mode').change(toggleUserCheckboxes);

        // User table search/sort
        function applyGuideUserFilters() {
            filterUserTableRows('#guide-user-search', '#guide-user-filter', '#guide-users-table');
        }
        function applyInternshipUserFilters() {
            filterUserTableRows('#internship-user-search', '#internship-user-filter', '#internship-users-table');
        }
        function applyGuideUserSort() {
            sortTableByField('#guide-users-table', 'userid', 'asc');
            applyGuideUserFilters();
        }
        function applyInternshipUserSort() {
            sortTableByField('#internship-users-table', 'userid', 'asc');
            applyInternshipUserFilters();
        }
        $('#guide-user-search').on('input', applyGuideUserFilters);
        $('#guide-user-filter').on('change', applyGuideUserFilters);
        $('#guide-users-table').on('change', 'input[type="checkbox"]', applyGuideUserFilters);
        $('#internship-user-search').on('input', applyInternshipUserFilters);
        $('#internship-user-filter').on('change', applyInternshipUserFilters);
        $('#internship-users-table').on('change', 'input[type="checkbox"]', applyInternshipUserFilters);
        setupSortableTable('#guide-users-table');
        setupSortableTable('#internship-users-table');
        $('.coverage-table').each(function() {
            setupSortableTable(this);
        });
        applyGuideUserSort();
        applyInternshipUserSort();

        // Check if settings were saved successfully
        [% IF saved_successfully %]
            toastr.success('Settings saved successfully!');
        [% END %]

        var modelDefaults = [% model_defaults_json || '{}' %];
        var promptDefaults = [% prompt_defaults_json || '{}' %];
        var defaultOpenAiModel = modelDefaults.openai || '';
        var defaultOpenRouterModel = modelDefaults.openrouter || '';
        var fallbackModel = modelDefaults.fallback || '';
        if (!defaultOpenAiModel && fallbackModel && fallbackModel !== 'default' && fallbackModel.indexOf('/') === -1) {
            defaultOpenAiModel = fallbackModel;
        }
        if (!defaultOpenRouterModel && fallbackModel && fallbackModel !== 'default' && fallbackModel.indexOf('/') !== -1) {
            defaultOpenRouterModel = fallbackModel;
        }
        var openAiModels = [];
        var openRouterModels = [];
        var activeProvider = ($('#llm_api_provider').val() || 'OpenRouter').toLowerCase();
        var modelSelections = {
            openai: defaultOpenAiModel || '',
            openrouter: defaultOpenRouterModel || ''
        };
        var modelWarnings = {
            openai: '',
            openrouter: ''
        };
        var modelWarningToasts = {
            openai: false,
            openrouter: false
        };
        var missingKeyToasts = {
            openai: false,
            openrouter: false
        };
        var draftModelValue = $('#ai_model').val();
        var draftProviderValue = ($('#llm_api_provider').val() || 'OpenRouter').toLowerCase();
        if (draftModelValue) {
            modelSelections[draftProviderValue] = draftModelValue;
        }

        if (!modelSelections.openai && activeProvider === 'openai' && fallbackModel) {
            modelSelections.openai = fallbackModel;
        }
        if (modelSelections.openai === 'default') {
            modelSelections.openai = '';
        }
        function promptDefaultsForMode() {
            if (promptDefaults && promptDefaults.plain) return promptDefaults.plain;
            if (promptDefaults && promptDefaults.default) return promptDefaults;
            return (promptDefaults && promptDefaults.active) ? promptDefaults.active : {};
        }

        function activePromptDefaults() {
            return promptDefaultsForMode();
        }

        function normalizePromptText(value) {
            return (value || '').toString().replace(/\r\n/g, '\n').trim();
        }

        function dedupePromptText(value) {
            var raw = (value || '').toString().replace(/\r\n/g, '\n');
            var lines = raw.split('\n');
            var out = [];
            var previous = '';
            var seenSingletons = {};
            var singletonLines = {
                'payload_json:': true,
                '{{payload_json}}': true,
                '{{source_text}}': true,
                'payload json:': true,
                'source text:': true
            };
            lines.forEach(function(line) {
                var cleaned = (line || '').replace(/\s+$/g, '');
                var key = cleaned.trim();
                var lowerKey = key.toLowerCase();
                if (!key) {
                    if (previous === '') return;
                    out.push('');
                    previous = '';
                    return;
                }
                if (singletonLines[lowerKey]) {
                    if (seenSingletons[lowerKey]) return;
                    seenSingletons[lowerKey] = true;
                }
                if (key === previous) return;
                out.push(cleaned);
                previous = key;
            });
            return out.join('\n').trim();
        }

        function canonicalPromptText(value) {
            return dedupePromptText(value).split('\n').map(function(line) {
                return (line || '').trim();
            }).join('\n').replace(/\n{3,}/g, '\n\n').trim();
        }

        function allDefaultsForPromptKey(defaultKey) {
            var values = [];
            function addFrom(source) {
                if (!source || typeof source !== 'object') return;
                if (source[defaultKey]) values.push(source[defaultKey]);
            }
            addFrom(promptDefaults && promptDefaults.plain);
            addFrom(promptDefaults && promptDefaults.active);
            addFrom(promptDefaults);
            return values;
        }

        function isKnownDefaultPrompt(value, defaultKey) {
            var canonical = canonicalPromptText(value);
            if (!canonical) return false;
            var defaults = allDefaultsForPromptKey(defaultKey);
            return defaults.some(function(item) {
                return canonicalPromptText(item) === canonical;
            });
        }

        function syncPromptValueForMode($field, defaultKey, currentDefault) {
            if (!$field || !$field.length) return;
            var currentValue = dedupePromptText($field.val());
            if (currentValue !== ($field.val() || '')) {
                $field.val(currentValue);
            }
            var currentNorm = canonicalPromptText(currentDefault);
            var currentCanonical = canonicalPromptText(currentValue);
            if (!currentCanonical
                || currentCanonical === currentNorm
                || isKnownDefaultPrompt(currentValue, defaultKey)) {
                $field.val(dedupePromptText(currentDefault || ''));
            }
        }

        function promptPlaceholderText(value) {
            var raw = normalizePromptText(value);
            return raw;
        }

        function updatePromptPlaceholders() {
            var defaults = promptDefaultsForMode();
            var defaultPrompt = (defaults && defaults.default) ? defaults.default : '';
            var catalogingPrompt = (defaults && defaults.cataloging) ? defaults.cataloging : '';
            syncPromptValueForMode($('#ai_prompt_default'), 'default', defaultPrompt);
            syncPromptValueForMode($('#ai_prompt_cataloging'), 'cataloging', catalogingPrompt);
            $('#ai_prompt_default').attr('placeholder', promptPlaceholderText(defaultPrompt));
            $('#ai_prompt_cataloging').attr('placeholder', promptPlaceholderText(catalogingPrompt));
            $('#ai_prompt_default_hint').text(
                'Punctuation prompt. Max [% ai_prompt_max_length || 16384 %] chars.'
            );
            $('#ai_prompt_cataloging_hint').text(
                'Cataloging prompt. Leave blank to use built-in default.'
            );
        }

        function providerLabel(provider) {
            return (provider || '').toLowerCase() === 'openrouter' ? 'OpenRouter' : 'OpenAI';
        }

        function providerHasSavedKey(provider) {
            var normalized = (provider || 'openrouter').toLowerCase();
            var $row = $('#ai-api-key-row');
            var openaiSet = Number($row.data('openai-set')) === 1;
            var openrouterSet = Number($row.data('openrouter-set')) === 1;
            return normalized === 'openrouter' ? openrouterSet : openaiSet;
        }

        function providerHasConfiguredKey(provider) {
            return providerHasSavedKey(provider);
        }

        function notifyProviderWarning(provider, warning) {
            var normalized = (provider || 'openrouter').toLowerCase();
            var message = (warning || '').toString().trim();
            if (!message || modelWarningToasts[normalized]) return;
            modelWarningToasts[normalized] = true;
            toastr.warning(providerLabel(normalized) + ': ' + message);
        }

        function notifyMissingSavedKey(provider) {
            var normalized = (provider || 'openrouter').toLowerCase();
            if (providerHasConfiguredKey(normalized) || missingKeyToasts[normalized]) return;
            missingKeyToasts[normalized] = true;
            toastr.warning(providerLabel(normalized) + ' API key is not configured on server.');
        }

        function fetchOpenRouterModelsViaServer(force) {
            return postPluginJson(pluginPath, 'ai_models', {
                provider: 'openrouter',
                force: force ? 1 : 0,
                allow_public: 1
            })
                .then(function(data) {
                    if (!data || typeof data !== 'object') {
                        return {
                            ok: 0,
                            provider: 'openrouter',
                            key_present: 0,
                            models: [],
                            warning: 'OpenRouter model lookup returned an invalid response.'
                        };
                    }
                    if (!data.warning && !data.key_present) {
                        data.warning = 'OpenRouter API key is not configured on server. Showing public models via server request.';
                    }
                    return data;
                })
                .catch(function(err) {
                    var message = (err && err.message) ? err.message : 'Network request failed.';
                    return {
                        ok: 0,
                        provider: 'openrouter',
                        key_present: 0,
                        models: [],
                        warning: 'OpenRouter model lookup via server failed (' + message + '). Enter model ID manually.'
                    };
                });
        }

        function fetchModels(provider, force) {
            var normalized = (provider || 'openrouter').toLowerCase();
            if (!providerHasSavedKey(normalized)) {
                if (normalized === 'openrouter') {
                    return fetchOpenRouterModelsViaServer(force);
                }
                return Promise.resolve({
                    ok: 0,
                    provider: normalized,
                    key_present: 0,
                    models: [],
                    warning: providerLabel(normalized) + ' API key is not configured on server.'
                });
            }
            return postPluginJson(pluginPath, 'ai_models', {
                provider: normalized,
                force: force ? 1 : 0
            });
        }

        function setModelSelect($select, models, selectedId, labelFn, options) {
            var opts = options || {};
            var defaultOption = opts.defaultOption;
            $select.empty();
            if (opts.includeBlank !== false) {
                var blank = $('<option>').attr('value', '').text('Select a model');
                if (!selectedId) blank.attr('selected', 'selected');
                $select.append(blank);
            }
            if (defaultOption) {
                var defaultLabel = defaultOption.label || defaultOption.id;
                var defaultItem = $('<option>').attr('value', defaultOption.id).text(defaultLabel);
                if (defaultOption.id === selectedId) defaultItem.attr('selected', 'selected');
                $select.append(defaultItem);
            }
            if (selectedId && (!defaultOption || selectedId !== defaultOption.id)
                && !models.some(function(item) { return item.id === selectedId; })) {
                models = [{ id: selectedId, name: selectedId }].concat(models);
            }
            models.forEach(function(model) {
                var label = labelFn ? labelFn(model) : (model.name || model.id);
                var option = $('<option>').attr('value', model.id).text(label);
                if (model.id === selectedId) option.attr('selected', 'selected');
                $select.append(option);
            });
            if ($.fn && $.fn.select2 && $select.data('select2')) {
                $select.trigger('change.select2');
            }
        }

        function loadOpenAiModels(force, selectedId) {
            fetchModels('openai', force)
                .then(function(data) {
                    if (data && data.error) {
                        toastr.error(data.error);
                        renderOpenAiModels(selectedId);
                        return;
                    }
                    modelWarnings.openai = (data && data.warning) ? data.warning : '';
                    notifyProviderWarning('openai', modelWarnings.openai);
                    if (!modelWarnings.openai) notifyMissingSavedKey('openai');
                    updateModelHint('openai');
                    openAiModels = (data && data.models) ? data.models : [];
                    renderOpenAiModels(selectedId);
                })
                .catch(function(err) {
                    toastr.error('OpenAI models unavailable: ' + err.message);
                    renderOpenAiModels(selectedId);
                });
        }

        function filterOpenAiModels(models) {
            var query = normalizeText($('#ai-model-search').val());
            return (models || []).filter(function(model) {
                if (!query) return true;
                var haystack = normalizeText((model && model.id) || '')
                    + ' '
                    + normalizeText((model && model.name) || '')
                    + ' '
                    + normalizeText((model && model.owned_by) || '');
                return haystack.indexOf(query) !== -1;
            });
        }

        function renderOpenAiModels(selectedId) {
            var filtered = filterOpenAiModels(openAiModels || []);
            var selected = (selectedId !== undefined && selectedId !== null)
                ? selectedId
                : (modelSelections.openai || '');
            setModelSelect($('#ai_model'), filtered, selected, function(model) {
                return model.id;
            }, { includeBlank: true });
        }

        function getModelTokens(model) {
            var tokens = [];
            function addTokens(value) {
                var raw = String(value).toLowerCase();
                raw.split(/[^a-z0-9]+/).forEach(function(token) {
                    if (token) tokens.push(token);
                });
            }
            ['modalities', 'input_modalities', 'output_modalities'].forEach(function(key) {
                var value = model[key];
                if (Array.isArray(value)) {
                    value.forEach(addTokens);
                } else if (value) {
                    addTokens(value);
                }
            });
            var architecture = model.architecture || {};
            ['modality', 'modalities', 'input_modalities', 'output_modalities'].forEach(function(key) {
                var value = architecture[key];
                if (Array.isArray(value)) {
                    value.forEach(addTokens);
                } else if (value) {
                    addTokens(value);
                }
            });
            return tokens;
        }

        function isFreeModel(model) {
            var pricing = model.pricing || {};
            var prompt = parseFloat(pricing.prompt || pricing.input || pricing.prompt_token || pricing.input_price || '1');
            var completion = parseFloat(pricing.completion || pricing.output || pricing.completion_token || pricing.output_price || '1');
            return prompt === 0 && completion === 0;
        }

        function hasModalities(model, key) {
            if (Array.isArray(model[key]) && model[key].length) return true;
            var architecture = model.architecture || {};
            return Array.isArray(architecture[key]) && architecture[key].length;
        }

        function openRouterModelSearchHints(model) {
            var hints = [];
            var tokens = getModelTokens(model);
            if (tokens.includes('text')) hints.push('text');
            if (tokens.includes('image')) hints.push('image');
            if (hasModalities(model, 'input_modalities')) hints.push('input');
            if (hasModalities(model, 'output_modalities')) hints.push('output');
            if (isFreeModel(model)) hints.push('free');
            hints = Array.from(new Set(hints));
            return hints.length ? (' [' + hints.join(' ') + ']') : '';
        }

        function filterOpenRouterModels(models) {
            var query = normalizeText($('#ai-model-search').val());
            var wantsText = $('#openrouter-filter-text').is(':checked');
            var wantsImage = $('#openrouter-filter-image').is(':checked');
            var wantsInput = $('#openrouter-filter-input').is(':checked');
            var wantsOutput = $('#openrouter-filter-output').is(':checked');
            var wantsFree = $('#openrouter-filter-free').is(':checked');
            return (models || []).filter(function(model) {
                var haystack = normalizeText((model && model.id) || '')
                    + ' '
                    + normalizeText((model && model.name) || '')
                    + ' '
                    + normalizeText((model && model.description) || '');
                if (query && haystack.indexOf(query) === -1) return false;
                var tokens = getModelTokens(model);
                if (wantsText && tokens.indexOf('text') === -1) return false;
                if (wantsImage && tokens.indexOf('image') === -1 && tokens.indexOf('vision') === -1) return false;
                if (wantsInput && !hasModalities(model, 'input_modalities') && tokens.indexOf('input') === -1) return false;
                if (wantsOutput && !hasModalities(model, 'output_modalities') && tokens.indexOf('output') === -1) return false;
                if (wantsFree && !isFreeModel(model)) return false;
                return true;
            });
        }

        function renderOpenRouterModels(selectedId) {
            var filtered = filterOpenRouterModels(openRouterModels || []);
            var selected = (selectedId !== undefined && selectedId !== null)
                ? selectedId
                : (modelSelections.openrouter || '');
            setModelSelect($('#ai_model'), filtered, selected, function(model) {
                var baseLabel = model.name ? (model.name + ' (' + model.id + ')') : model.id;
                return baseLabel + openRouterModelSearchHints(model);
            }, { includeBlank: true });
        }

        function loadOpenRouterModels(force, selectedId) {
            fetchModels('openrouter', force)
                .then(function(data) {
                    if (data && data.error) {
                        toastr.error(data.error);
                        renderOpenRouterModels(selectedId);
                        return;
                    }
                    modelWarnings.openrouter = (data && data.warning) ? data.warning : '';
                    notifyProviderWarning('openrouter', modelWarnings.openrouter);
                    if (!modelWarnings.openrouter) notifyMissingSavedKey('openrouter');
                    updateModelHint('openrouter');
                    openRouterModels = (data && data.models) ? data.models : [];
                    renderOpenRouterModels(selectedId);
                })
                .catch(function(err) {
                    toastr.error('OpenRouter models unavailable: ' + err.message);
                    renderOpenRouterModels(selectedId);
                });
        }

        function updateModelHint(provider) {
            var normalized = (provider || 'openai').toLowerCase();
            var text = normalized === 'openrouter'
                ? 'Use search and filters to pick an OpenRouter model.'
                : 'Use search to pick an OpenAI model ID.';
            text += ' Server mode: model list loads through Koha.';
            var warning = modelWarnings[normalized] || '';
            if (warning) text += ' ' + warning;
            $('#ai-model-hint').text(text);
        }

        function updateApiKeyUi(provider) {
            var normalized = (provider || 'openrouter').toLowerCase();
            var $row = $('#ai-api-key-row');
            var openaiSet = Number($row.data('openai-set')) === 1;
            var openrouterSet = Number($row.data('openrouter-set')) === 1;
            var isOpenRouter = normalized === 'openrouter';
            var label = isOpenRouter ? 'OpenRouter API Key:' : 'OpenAI API Key:';
            var hint = isOpenRouter
                ? 'Stored in Koha on the server.'
                : 'Stored in Koha on the server.';
            var isSet = isOpenRouter ? openrouterSet : openaiSet;
            if (isSet) hint += ' (set)';
            $('#ai-api-key-label').text(label);
            $('#ai-api-key-hint').text(hint);
            $('#clear-ai-key').prop('disabled', !isSet);
            var $indicator = $('#ai-api-key-indicator');
            if (isSet) {
                $indicator.text('Saved').removeClass('is-empty').addClass('is-set').show();
            } else {
                $indicator.text('Not set').removeClass('is-set').addClass('is-empty').show();
            }
            $('#ai_api_key').attr('placeholder', 'Stored on server after save');
        }

        function toggleAiProviderFields() {
            var provider = ($('#llm_api_provider').val() || 'OpenRouter').toLowerCase();
            var isOpenRouter = provider === 'openrouter';
            $('.openai-only').toggle(!isOpenRouter);
            $('.openrouter-only').toggle(isOpenRouter);
            $('#ai-model-search').attr('placeholder', isOpenRouter ? 'Search OpenRouter models...' : 'Search OpenAI models...');
            $('.openrouter-filters input').prop('disabled', !isOpenRouter);
            $('#ai_api_key_clear').val('0');
            updateModelHint(provider);
            updateApiKeyUi(provider);
            notifyMissingSavedKey(provider);
        }

        function ensureOpenRouterFilterDefaults() {
            var $filters = $('.openrouter-filters input');
            if (!$filters.length) return;
            if ($filters.filter(':checked').length) return;
            $('#openrouter-filter-text').prop('checked', true);
            $('#openrouter-filter-input').prop('checked', true);
            $('#openrouter-filter-output').prop('checked', true);
        }

        function loadModelsForProvider(provider, force) {
            var normalized = (provider || 'openai').toLowerCase();
            if (!providerHasConfiguredKey(normalized)) {
                modelWarnings[normalized] = providerLabel(normalized) + ' API key is not configured on server.';
                updateModelHint(normalized);
                notifyMissingSavedKey(normalized);
                if (normalized === 'openrouter') {
                    // OpenRouter can still provide public models via server endpoint.
                    loadOpenRouterModels(force, modelSelections.openrouter);
                } else {
                    openAiModels = [];
                    renderOpenAiModels(modelSelections.openai);
                }
                return;
            }
            if (normalized === 'openrouter') {
                loadOpenRouterModels(force, modelSelections.openrouter);
            } else {
                loadOpenAiModels(force, modelSelections.openai);
            }
        }

        ensureOpenRouterFilterDefaults();
        toggleAiProviderFields();
        loadModelsForProvider($('#llm_api_provider').val() || 'openrouter', false);
        $('#llm_api_provider').on('change', function() {
            modelSelections[activeProvider] = $('#ai_model').val() || modelSelections[activeProvider] || '';
            activeProvider = ($(this).val() || 'OpenRouter').toLowerCase();
            toggleAiProviderFields();
            loadModelsForProvider(activeProvider, false);
        });
        $('#refresh-ai-models').on('click', function() {
            loadModelsForProvider(activeProvider, true);
        });
        $('#ai_model').on('change', function() {
            modelSelections[activeProvider] = $(this).val() || modelSelections[activeProvider] || '';
        });
        $('#ai-model-search').on('input', function() {
            if (activeProvider === 'openrouter') {
                renderOpenRouterModels();
            } else {
                renderOpenAiModels();
            }
        });
        $('.openrouter-filters input').on('change', function() {
            if (activeProvider === 'openrouter') {
                renderOpenRouterModels();
            }
        });

        // Training progress
        fetchProgressTable(pluginPath);
        $('#progress-search').on('input', applyProgressFilters);
        $('#progress-status-filter').on('change', applyProgressFilters);
        $('#progress-tier-filter').on('change', applyProgressFilters);
        $('#progress-module-filter').on('change', applyProgressFilters);
        $('#progress-refresh').on('click', function() {
            fetchProgressTable(pluginPath);
        });
        $('#progress-export-csv').on('click', function() {
            exportProgressAsCsv();
        });
        $('#progress-export-excel').on('click', function() {
            exportProgressAsExcel();
        });
        var progressTimer = null;
        $('#progress-auto-refresh').on('change', function() {
            var enabled = $(this).is(':checked');
            if (progressTimer) {
                clearInterval(progressTimer);
                progressTimer = null;
            }
            if (enabled) {
                progressTimer = setInterval(function() {
                    fetchProgressTable(pluginPath);
                }, 30000);
            }
        });
        $('#progress-auto-refresh').trigger('change');

        $('#ai-test-connection').on('click', function() {
            toastr.info('Testing server AI connection...');
            postPluginJson(pluginPath, 'test_connection', {})
                .then(function(data) {
                    if (data.error) {
                        toastr.error(data.error);
                        return;
                    }
                    toastr.success('Server AI connection successful.');
                })
                .catch(function(err) { toastr.error('AI connection failed: ' + err.message); });
        });
        function setupUnifiedKey() {
            $('#clear-ai-key').on('click', function() {
                var provider = ($('#llm_api_provider').val() || 'OpenRouter').toLowerCase();
                var label = provider === 'openrouter' ? 'OpenRouter' : 'OpenAI';
                if (!confirm('Clear stored ' + label + ' key? This cannot be undone.')) return;
                $('#ai_api_key_clear').val('1');
                $('#ai_api_key').val('');
                var $row = $('#ai-api-key-row');
                if (provider === 'openrouter') {
                    $row.data('openrouter-set', 0);
                } else {
                    $row.data('openai-set', 0);
                }
                updateApiKeyUi(provider);
                toastr.info(label + ' key cleared. Save configuration to apply.');
            });
            $('#ai_api_key').on('input', function() {
                if ($(this).val()) {
                    $('#ai_api_key_clear').val('0');
                }
            });
        }

        setupUnifiedKey();

        $('#reset-ai-prompts').on('click', function() {
            var defaults = activePromptDefaults();
            var defaultPrompt = (defaults && defaults.default) ? defaults.default : '';
            var catalogingPrompt = (defaults && defaults.cataloging) ? defaults.cataloging : '';
            $('#ai_prompt_default').val(dedupePromptText(defaultPrompt)).trigger('input');
            $('#ai_prompt_cataloging').val(dedupePromptText(catalogingPrompt)).trigger('input');
            toastr.info('Prompt fields reset to shipped defaults. Save configuration to apply.');
        });

        updatePromptPlaceholders();

        $('form').on('submit', function() {
            isConfigurationSubmitInProgress = true;
            if (progressTimer) {
                clearInterval(progressTimer);
                progressTimer = null;
            }
            if (progressFetchController) {
                try { progressFetchController.abort(); } catch (err) { /* ignore */ }
            }
        });

        $('form').on('input change', 'input, select, textarea', function() {
            saveDraftSoon();
        });
        $('#aacr2-config-tabs a').on('click', function() {
            saveDraftSoon();
        });
    });

    // Validate JSON on save
    $('form').on('submit', function(e) {
        if ($(e.target).find('[name="save"]').length) {
            try {
                JSON.parse(editor.getValue());
            } catch (error) {
                e.preventDefault();
                isConfigurationSubmitInProgress = false;
                alert('Invalid JSON in custom rules: ' + error.message);
                return false;
            }
        }
    });

    // Auto-format JSON
    $('#custom-rules-editor').next().find('.CodeMirror').after(
        '<button type="button" class="btn btn-sm btn-default" onclick="formatJSON()" style="margin-top: 5px;">' +
        '<i class="fa fa-indent"></i> Format JSON</button>'
    );

    function formatJSON() {
        try {
            var formatted = JSON.stringify(JSON.parse(editor.getValue()), null, 2);
            editor.setValue(formatted);
        } catch (error) {
            alert('Cannot format: Invalid JSON');
        }
    }
</script>
[% INCLUDE 'intranet-bottom.inc' %]
