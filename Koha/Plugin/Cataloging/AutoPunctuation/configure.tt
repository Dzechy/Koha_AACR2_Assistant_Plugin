[% INCLUDE 'doc-head-open.inc' %]
<title>Koha: Auto-Punctuation Plugin: Configuration</title>
[% INCLUDE 'doc-head-close.inc' %]
[% INCLUDE 'calendar.inc' %]
<style>
    #custom-rules-editor {
        width: 100%;
        height: 400px;
        border: 1px solid #ddd;
        font-family: monospace;
        border-radius: 4px;
    }
    .exclusion-list {
        width: 100%;
        min-height: 60px;
        border-radius: 4px;
    }
    .configuration-section {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    .configuration-section legend {
        background: #337ab7;
        color: white;
        padding: 5px 15px;
        border-radius: 4px 4px 0 0;
        margin: 0;
        width: 100%;
        font-size: 14px;
    }
    .configuration-section .rows {
        padding: 15px;
        margin: 0;
    }
    .hint {
        color: #666;
        font-size: 0.9em;
        font-style: italic;
        display: block;
        margin-top: 3px;
    }
    .alert-success {
        background: #dff0d8;
        border: 1px solid #d6e9c6;
        color: #3c763d;
        padding: 10px;
        border-radius: 4px;
    }
    .select2-container {
        width: 100% !important;
    }
    .user-table {
        width: 100%;
        border-collapse: collapse;
    }
    .user-table th, .user-table td {
        border: 1px solid #ddd;
        padding: 8px;
    }
    .user-table th {
        background-color: #f2f2f2;
    }
    .disabled-checkbox {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .warning-text {
        color: red;
        font-weight: bold;
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"/>
<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Include jQuery UI -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
</head>
<body>
[% INCLUDE 'header.inc' %]
[% INCLUDE 'cat-search.inc' %]
<div id="breadcrumbs">
    <a href="/cgi-bin/koha/mainpage.pl">Home</a> ›
    <a href="/cgi-bin/koha/plugins/plugins-home.pl">Plugins</a> ›
    <a href="#" class="active">Auto-Punctuation Plugin Configuration</a>
</div>
<div class="main container-fluid">
    <div class="row">
        <div class="col-sm-10 col-sm-push-2">
            <main>
                <h1>Auto-Punctuation Plugin Configuration</h1>

                [% IF settings.last_updated %]
                <div class="alert alert-success">
                    <p><i class="fa fa-check-circle"></i> Last updated: [% settings.last_updated %]</p>
                </div>
                [% END %]

                <form method="post" enctype="multipart/form-data">
                    <input type="hidden" name="class" value="[% CLASS %]"/>
                    <input type="hidden" name="method" value="[% METHOD %]"/>
                    <input type="hidden" name="save" value="1"/>

                    <fieldset class="configuration-section">
                        <legend>Basic Settings</legend>
                        <ol class="rows">
                            <li>
                                <label for="enabled">Enable Auto-Punctuation:</label>
                                <input type="checkbox" name="enabled" id="enabled" value="1" [% IF settings.enabled %]checked[% END %]/>
                                <span class="hint">Check to enable automatic punctuation in cataloging forms</span>
                            </li>
                            <li>
                                <label for="default_standard">Default Cataloging Standard:</label>
                                <select name="default_standard" id="default_standard" class="form-control" style="width: auto; display: inline-block;">
                                    <option value="AACR2" [% IF settings.default_standard == 'AACR2' %]selected[% END %]>AACR2</option>
                                    <option value="RDA" [% IF settings.default_standard == 'RDA' %]selected[% END %]>RDA</option>
                                </select>
                                <span class="hint">Choose the default cataloging standard for punctuation rules</span>
                            </li>
                            <li>
                                <label for="debug_mode">Debug Mode:</label>
                                <input type="checkbox" name="debug_mode" id="debug_mode" value="1" [% IF settings.debug_mode %]checked[% END %]/>
                                <span class="hint">Enable console logging for troubleshooting (only enable if needed)</span>
                            </li>
                        </ol>
                    </fieldset>
                    <fieldset class="configuration-section">
                        <legend>Interactive Training Guide</legend>
                        <ol class="rows">
                            <li>
                                <label for="enable_guide">Enable Interactive Guide:</label>
                                <input type="checkbox" name="enable_guide" id="enable_guide" value="1" [% IF settings.enable_guide %]checked[% END %]/>
                                <span class="hint">Enable step-by-step AACR2/RDA guide for training</span>
                            </li>
                            <li>
                                <label for="guide_users">Exclude Users from Guide:</label>
                                <table class="user-table">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input type="checkbox" id="selectAllGuideUsers" onclick="toggleSelectAll('guide_users', this.checked)"/>
                                            </th>
                                            <th>User ID</th>
                                            <th>Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        [% FOREACH user IN users %]
                                        <tr>
                                            <td>
                                                <input type="checkbox" name="guide_users" value="[% user.userid %]"
                                                [% FOREACH selected_user IN settings.guide_users.split(',') %]
                                                    [% IF selected_user.trim == user.userid %]checked[% END %]
                                                [% END %]
                                                [% IF !settings.enable_guide %]disabled class="disabled-checkbox"[% END %]>
                                            </td>
                                            <td>[% user.userid %]</td>
                                            <td>[% user.name %]</td>
                                        </tr>
                                        [% END %]
                                    </tbody>
                                </table>
                                <span class="hint">Select users to exclude from accessing the guide (multiple selections allowed)</span>
                            </li>
                            <li>
                                <label for="guide_exclusion_list">Manual Exclusion List (Optional):</label>
                                <textarea name="guide_exclusion_list" id="guide_exclusion_list" class="exclusion-list form-control">[% settings.guide_exclusion_list %]</textarea>
                                <span class="hint">Comma-separated usernames to exclude manually (e.g., user1,user2). Matches against loggedinusername class text content.</span>
                            </li>
                        </ol>
                    </fieldset>
                    <fieldset class="configuration-section">
                        <legend>Custom Punctuation Rules</legend>
                        <ol class="rows">
                            <li>
                                <label for="custom-rules-editor">Custom Rules (JSON):</label>
                                <textarea name="custom_rules" id="custom-rules-editor">[% settings.custom_rules || '{}' %]</textarea>
                                <span class="hint">Edit custom punctuation rules in JSON format. Example: {"AACR2": {"245a": {"prefix": "", "suffix": "."}}}</span>
                            </li>
                            <li>
                                <label>Import/Export Rules:</label>
                                <div style="margin-top: 5px;">
                                    <input type="file" name="rules_file" id="rules_file" accept=".json" class="form-control" style="width: auto; display: inline-block;"/>
                                    <button type="submit" name="import_rules" value="1" class="btn btn-default">
                                        <i class="fa fa-upload"></i> Import Rules
                                    </button>
                                    <button type="submit" name="export_rules" value="1" class="btn btn-default">
                                        <i class="fa fa-download"></i> Export Rules
                                    </button>
                                </div>
                                <span class="hint">Upload a .json file to import rules or download current rules</span>
                            </li>
                        </ol>
                    </fieldset>
                    <fieldset class="configuration-section">
                        <legend>Internship Training Mode</legend>
                        <ol class="rows">
                            <li>
                                <label for="internship_mode">Enable Internship Mode:</label>
                                <input type="checkbox" name="internship_mode" id="internship_mode" value="1" [% IF settings.internship_mode %]checked[% END %]/>
                                <span class="hint">Disable auto-punctuation for selected users to support manual learning</span>
                            </li>
                            <li>
                                <label for="internship_users">Select Internship Users:</label>
                                <table class="user-table">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input type="checkbox" id="selectAllInternshipUsers" onclick="toggleSelectAll('internship_users', this.checked)"/>
                                            </th>
                                            <th>User ID</th>
                                            <th>Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        [% FOREACH user IN users %]
                                        <tr>
                                            <td>
                                                <input type="checkbox" name="internship_users" value="[% user.userid %]"
                                                [% FOREACH selected_user IN settings.internship_users.split(',') %]
                                                    [% IF selected_user.trim == user.userid %]checked[% END %]
                                                [% END %]
                                                [% IF !settings.internship_mode %]disabled class="disabled-checkbox"[% END %]>
                                            </td>
                                            <td>[% user.userid %]</td>
                                            <td>[% user.name %]</td>
                                        </tr>
                                        [% END %]
                                    </tbody>
                                </table>
                                <span class="hint">Select users to exclude from auto-punctuation (multiple selections allowed)</span>
                            </li>
                            <li>
                                <label for="internship_exclusion_list">Manual Exclusion List:</label>
                                <textarea name="internship_exclusion_list" id="internship_exclusion_list" class="exclusion-list form-control">[% settings.internship_exclusion_list %]</textarea>
                                <span class="hint">Comma-separated usernames to exclude manually (e.g., user1,user2). Matches against loggedinusername class text content.</span>
                            </li>
                        </ol>
                    </fieldset>
                    <fieldset class="configuration-section">
                        <legend>AI Classification</legend>
                        <ol class="rows">
                            <li>
                                <label for="llm_api_provider">AI Provider:</label>
                                <select name="llm_api_provider" id="llm_api_provider" class="form-control" style="width: auto; display: inline-block;">
                                    <option value="OpenAI" [% IF settings.llm_api_provider == 'OpenAI' %]selected[% END %]>OpenAI</option>
                                    <option value="DeepSeek" [% IF settings.llm_api_provider == 'DeepSeek' %]selected[% END %]>DeepSeek</option>
                                </select>
                                <span class="hint">Select the AI provider for classification tasks</span>
                            </li>
                            <li>
                                <label for="llm_api_key">API Key:</label>
                                <input type="password" name="llm_api_key" id="llm_api_key" value="[% settings.llm_api_key %]" class="form-control" style="width: 300px;"/>
                                <span class="hint">
                                    Enter your API key for the selected provider.
                                    Get your OpenAI key at <a href="https://platform.openai.com/account/api-keys" target="_blank">platform.openai.com</a> or
                                    DeepSeek key at <a href="https://platform.deepseek.com/api_keys" target="_blank">platform.deepseek.com</a>
                                </span>
                            </li>
                            <li>
                                <div class="alert alert-info">
                                    <p><strong>About AI Classification:</strong></p>
                                    <ul>
                                        <li>Analyzes title, subtitle, and summary fields</li>
                                        <li>Suggests subject headings (650/651 fields)</li>
                                        <li>Proposes Library of Congress and Dewey classifications</li>
                                        <li>Generates call number suggestions</li>
                                        <li>Only fills empty fields - won't overwrite existing data</li>
                                    </ul>
                                </div>
                            </li>
                        </ol>
                    </fieldset>

                    <fieldset class="action">
                        <input type="submit" value="Save Configuration" class="btn btn-primary"/>
                        <a href="/cgi-bin/koha/plugins/run.pl?class=[% CLASS %]&method=tool" class="btn btn-default">Cancel</a>
                    </fieldset>
                </form>
            </main>
        </div>
        <div class="col-sm-2 col-sm-pull-10">
            <aside>
                [% INCLUDE 'tools-menu.inc' %]
            </aside>
        </div>
    </div>
</div>
<script>
    // Initialize CodeMirror for JSON editor
    var editor = CodeMirror.fromTextArea(document.getElementById('custom-rules-editor'), {
        mode: 'application/json',
        lineNumbers: true,
        theme: 'default',
        lint: true,
        autoCloseBrackets: true,
        matchBrackets: true,
        indentWithTabs: false,
        indentUnit: 2
    });

    // Toggle select all checkboxes
    function toggleSelectAll(className, checked) {
        $('input[type="checkbox"][name="' + className + '"]').prop('checked', checked);
    }

    // Toggle user checkboxes based on mode enable checkbox
    function toggleUserCheckboxes() {
        var isGuideEnabled = $('#enable_guide').is(':checked');
        var isInternshipEnabled = $('#internship_mode').is(':checked');

        $('input[name="guide_users"]').prop('disabled', !isGuideEnabled);
        $('input[name="internship_users"]').prop('disabled', !isInternshipEnabled);

        if (!isGuideEnabled) {
            $('input[name="guide_users"]').prop('checked', false);
        }

        if (!isInternshipEnabled) {
            $('input[name="internship_users"]').prop('checked', false);
        }
    }

    // Document ready function
    $(document).ready(function() {
        // Initialize Select2 for multi-select dropdowns
        $('#guide_users, #internship_users, #llm_api_provider').select2({
            placeholder: "Select option",
            allowClear: true,
            width: '100%'
        });

        // Toggle user checkboxes based on initial state
        toggleUserCheckboxes();

        // Event handlers for enabling/disabling user checkboxes
        $('#enable_guide').change(toggleUserCheckboxes);
        $('#internship_mode').change(toggleUserCheckboxes);

        // Check if settings were saved successfully
        [% IF saved_successfully %]
            toastr.success('Settings saved successfully!');
        [% END %]
    });

    // Validate JSON on save
    $('form').on('submit', function(e) {
        if ($(e.target).find('[name="save"]').length) {
            try {
                JSON.parse(editor.getValue());
            } catch (error) {
                e.preventDefault();
                alert('Invalid JSON in custom rules: ' + error.message);
                return false;
            }
        }
    });

    // Auto-format JSON
    $('#custom-rules-editor').next().find('.CodeMirror').after(
        '<button type="button" class="btn btn-sm btn-default" onclick="formatJSON()" style="margin-top: 5px;">' +
        '<i class="fa fa-indent"></i> Format JSON</button>'
    );

    function formatJSON() {
        try {
            var formatted = JSON.stringify(JSON.parse(editor.getValue()), null, 2);
            editor.setValue(formatted);
        } catch (error) {
            alert('Cannot format: Invalid JSON');
        }
    }
</script>
[% INCLUDE 'intranet-bottom.inc' %]

