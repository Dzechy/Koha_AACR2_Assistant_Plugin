[% INCLUDE 'doc-head-open.inc' %]
<title>Koha: AACR2 MARC21 Intellisense + Guardrails Configuration</title>
[% INCLUDE 'doc-head-close.inc' %]
[% INCLUDE 'calendar.inc' %]
<style>
    :root {
        --aacr2-accent: #0c223f;
        --aacr2-accent-soft: #e7eef7;
        --aacr2-border: #d7dde6;
        --aacr2-surface: #f4f7fb;
        --aacr2-card: #ffffff;
        --aacr2-muted: #5b6b7c;
        --aacr2-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
    }
    #custom-rules-editor {
        width: 100%;
        height: 400px;
        border: 1px solid var(--aacr2-border);
        font-family: monospace;
        border-radius: 6px;
    }
    .exclusion-list {
        width: 100%;
        min-height: 60px;
        border-radius: 6px;
        border: 1px solid var(--aacr2-border);
    }
    .configuration-section {
        background: var(--aacr2-card);
        border: 1px solid var(--aacr2-border);
        border-radius: 8px;
        margin-bottom: 24px;
        box-shadow: var(--aacr2-shadow);
    }
    .configuration-section legend {
        background: var(--aacr2-accent);
        color: white;
        padding: 8px 16px;
        border-radius: 8px 8px 0 0;
        margin: 0;
        width: 100%;
        font-size: 13px;
        letter-spacing: 0.3px;
        text-transform: uppercase;
    }
    .configuration-section .rows {
        padding: 18px 18px 12px 18px;
        margin: 0;
    }
    .configuration-section .rows > li {
        padding: 10px 0;
        border-bottom: 1px dashed var(--aacr2-border);
    }
    .configuration-section .rows > li:last-child {
        border-bottom: none;
    }
    .hint {
        color: var(--aacr2-muted);
        font-size: 12px;
        font-style: normal;
        display: block;
        margin-top: 3px;
    }
    .alert-success {
        background: #dff0d8;
        border: 1px solid #d6e9c6;
        color: #3c763d;
        padding: 10px;
        border-radius: 4px;
    }
    .select2-container {
        width: 100% !important;
    }
    #llm_api_provider {
        max-width: 260px;
    }
    #llm_api_provider + .select2-container {
        max-width: 260px;
        width: 100% !important;
    }
    #llm_api_provider + .select2-container .select2-selection__rendered {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .user-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--aacr2-card);
        border-radius: 8px;
        overflow: hidden;
    }
    .user-table th, .user-table td {
        border: 1px solid var(--aacr2-border);
        padding: 8px;
    }
    .user-table th {
        background-color: var(--aacr2-surface);
    }
    .user-table th.sortable {
        cursor: pointer;
    }
    .table-tools {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
        align-items: center;
    }
    .table-tools input[type="text"] {
        max-width: 280px;
    }
    .progress-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
        align-items: center;
    }
    .disabled-checkbox {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .ai-key-indicator {
        display: inline-block;
        margin-left: 6px;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
    }
    .ai-key-indicator.is-set {
        background: #dff0d8;
        color: #3c763d;
    }
    .ai-key-indicator.is-empty {
        background: #f5f5f5;
        color: #8a8a8a;
    }
    .warning-text {
        color: red;
        font-weight: bold;
    }
    .coverage-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .coverage-table th, .coverage-table td {
        border: 1px solid var(--aacr2-border);
        padding: 6px 8px;
        font-size: 12px;
    }
    .coverage-table th {
        background: var(--aacr2-surface);
    }
    .coverage-status-covered { color: #3c763d; font-weight: bold; }
    .coverage-status-excluded { color: #8a6d3b; font-weight: bold; }
    .coverage-status-missing { color: #a94442; font-weight: bold; }
    .openrouter-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 6px;
    }
    .openrouter-filters label {
        font-weight: 400;
        font-size: 12px;
        color: var(--aacr2-muted);
    }
    .aacr2-tabs.nav-tabs {
        border-bottom: none;
        gap: 12px;
        margin-bottom: 6px;
    }
    .aacr2-tabs .nav-link {
        border: none;
        padding: 0;
        background: transparent;
        color: var(--aacr2-muted);
        text-decoration: underline;
        text-decoration-color: transparent;
        text-underline-offset: 4px;
        font-weight: 600;
    }
    .aacr2-tabs .nav-link:hover,
    .aacr2-tabs .nav-link:focus {
        color: var(--aacr2-accent);
        text-decoration-color: var(--aacr2-accent);
    }
    .aacr2-tabs .nav-link.active {
        color: var(--aacr2-accent);
        text-decoration-color: var(--aacr2-accent);
    }
</style>
<link rel="stylesheet" href="[% PLUGIN_PATH %]/static/vendor/codemirror/codemirror.min.css"/>
<link rel="stylesheet" href="[% PLUGIN_PATH %]/static/vendor/select2/select2.min.css"/>
<link rel="stylesheet" href="[% PLUGIN_PATH %]/static/vendor/toastr/toastr.min.css"/>
<script src="[% PLUGIN_PATH %]/static/vendor/codemirror/codemirror.min.js"></script>
<script src="[% PLUGIN_PATH %]/static/vendor/codemirror/mode/javascript/javascript.min.js"></script>
<script src="[% PLUGIN_PATH %]/static/vendor/select2/select2.min.js"></script>
<script src="[% PLUGIN_PATH %]/static/vendor/toastr/toastr.min.js"></script>
</head>
<body>
[% INCLUDE 'header.inc' %]
[% INCLUDE 'cat-search.inc' %]
<div id="breadcrumbs">
    <a href="/cgi-bin/koha/mainpage.pl">Home</a> ›
    <a href="/cgi-bin/koha/plugins/plugins-home.pl">Plugins</a> ›
    <a href="#" class="active">AACR2 MARC21 Intellisense + Guardrails Configuration</a>
</div>
<div class="main container-fluid">
    <div class="row">
        <div class="col-sm-10 col-sm-push-2">
            <main>
                <h1>AACR2 MARC21 Intellisense + Guardrails Configuration</h1>

                [% IF settings.last_updated %]
                <div class="alert alert-success">
                    <p><i class="fa fa-check-circle"></i> Last updated: [% settings.last_updated %]</p>
                </div>
                [% END %]
                [% IF save_errors && save_errors.size %]
                <div class="alert alert-danger">
                    <p><strong>Unable to save configuration:</strong></p>
                    <ul>
                        [% FOREACH err IN save_errors %]
                            <li>[% err %]</li>
                        [% END %]
                    </ul>
                </div>
                [% END %]
                [% IF saved_successfully %]
                <div class="alert alert-success">
                    <p><i class="fa fa-check-circle"></i> Settings saved successfully.</p>
                </div>
                [% END %]
                [% IF update_info && update_info.update_available %]
                <div class="alert alert-warning">
                    <p><i class="fa fa-exclamation-circle"></i> New release available: [% update_info.latest_version %] (current [% current_version %]).</p>
                    <p><a href="[% update_info.release_url %]" target="_blank" rel="noopener">View release on GitHub</a></p>
                </div>
                [% END %]
                <div class="alert alert-info">
                    <p><strong>Author LinkedIn:</strong> <a href="[% author_linkedin %]" target="_blank" rel="noopener">[% author_linkedin %]</a></p>
                    <p><strong>Plugin GitHub:</strong> <a href="[% plugin_repo_url %]" target="_blank" rel="noopener">[% plugin_repo_url %]</a></p>
                    <p><strong>Run Tool:</strong> <a href="/cgi-bin/koha/plugins/run.pl?class=[% CLASS %]&method=tool">Open tool page</a></p>
                </div>

                <form method="post" enctype="multipart/form-data">
                    <input type="hidden" name="class" value="[% CLASS %]"/>
                    <input type="hidden" name="method" value="[% METHOD %]"/>
                    <input type="hidden" name="save" value="1"/>
                    <input type="hidden" name="csrf_token" id="csrf_token" value="[% csrf_token %]"/>

                    <ul class="nav nav-tabs aacr2-tabs" id="aacr2-config-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" href="#aacr2-tab-general" data-bs-toggle="tab" role="tab" aria-controls="aacr2-tab-general" aria-selected="true">General</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" href="#aacr2-tab-ai" data-bs-toggle="tab" role="tab" aria-controls="aacr2-tab-ai" aria-selected="false">AI Assist</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" href="#aacr2-tab-rules" data-bs-toggle="tab" role="tab" aria-controls="aacr2-tab-rules" aria-selected="false">Rules &amp; Validation</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" href="#aacr2-tab-training" data-bs-toggle="tab" role="tab" aria-controls="aacr2-tab-training" aria-selected="false">Training</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" href="#aacr2-tab-advanced" data-bs-toggle="tab" role="tab" aria-controls="aacr2-tab-advanced" aria-selected="false">Advanced/Debug</a>
                        </li>
                    </ul>
                    <div class="tab-content" style="margin-top: 16px;">
                        <div class="tab-pane fade show active" id="aacr2-tab-general" role="tabpanel">
                            <fieldset class="configuration-section">
                                <legend>Basic Settings</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="enabled">Enable AACR2 Intellisense:</label>
                                        <input type="checkbox" name="enabled" id="enabled" value="1" [% IF settings.enabled %]checked[% END %]/>
                                        <span class="hint">Check to enable AACR2 rules and guardrails on cataloging forms</span>
                                    </li>
                                    <li>
                                        <label for="auto_apply_punctuation">Auto-Apply Punctuation:</label>
                                        <input type="checkbox" name="auto_apply_punctuation" id="auto_apply_punctuation" value="1" [% IF settings.auto_apply_punctuation %]checked[% END %]/>
                                        <span class="hint">When disabled, punctuation is suggested only and must be applied explicitly.</span>
                                    </li>
                                    <li>
                                        <label for="default_standard">Cataloging Standard:</label>
                                        <select name="default_standard" id="default_standard" class="form-control" style="width: auto; display: inline-block;">
                                            <option value="AACR2" selected>AACR2</option>
                                        </select>
                                        <span class="hint">AACR2 is enforced for MARC21 punctuation and guardrails.</span>
                                    </li>
                                </ol>
                            </fieldset>
                        </div>
                        <div class="tab-pane fade" id="aacr2-tab-ai" role="tabpanel">
                            <fieldset class="configuration-section">
                                <legend>AI Assist (Optional)</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="ai_enable">Enable AI Assist:</label>
                                        <input type="checkbox" name="ai_enable" id="ai_enable" value="1" [% IF settings.ai_enable %]checked[% END %]/>
                                        <span class="hint">AI is advisory only. Nothing is auto-applied.</span>
                                    </li>
                                    <li>
                                        <label for="ai_punctuation_explain">AI Field Guidance:</label>
                                        <input type="checkbox" name="ai_punctuation_explain" id="ai_punctuation_explain" value="1" [% IF settings.ai_punctuation_explain %]checked[% END %]/>
                                        <span class="hint">Explain AACR2 field rules for the selected field (same-field only).</span>
                                    </li>
                                    <li>
                                        <label for="ai_subject_guidance">AI Subject Guidance:</label>
                                        <input type="checkbox" name="ai_subject_guidance" id="ai_subject_guidance" value="1" [% IF settings.ai_subject_guidance %]checked[% END %]/>
                                        <span class="hint">Suggest subject headings based on the title (guidance only).</span>
                                    </li>
                                    <li>
                                        <label for="ai_callnumber_guidance">AI Call Number Guidance:</label>
                                        <input type="checkbox" name="ai_callnumber_guidance" id="ai_callnumber_guidance" value="1" [% IF settings.ai_callnumber_guidance %]checked[% END %]/>
                                        <span class="hint">Suggest classification numbers (used to build call numbers).</span>
                                    </li>
                                    <li>
                                        <label for="lc_class_target">LC Classification Target (tag$subfield):</label>
                                        <input type="text" name="lc_class_target" id="lc_class_target" value="[% settings.lc_class_target || '050$a' %]" class="form-control" style="width: 140px;"/>
                                        <span class="hint">Where fallback LC classification suggestions should apply (e.g., 050$a or 090$a).</span>
                                    </li>
                                    <li>
                                        <label for="llm_api_provider">AI Provider:</label>
                                        [% SET ai_provider_norm = (settings.llm_api_provider || 'OpenRouter') | lower %]
                                        <select name="llm_api_provider" id="llm_api_provider" class="form-control" style="width: 260px; max-width: 100%; display: inline-block;">
                                            <option value="OpenRouter" [% IF ai_provider_norm == 'openrouter' %]selected[% END %]>OpenRouter (recommended)</option>
                                            <option value="OpenAI" [% IF ai_provider_norm == 'openai' %]selected[% END %]>OpenAI</option>
                                        </select>
                                        <span class="hint">Choose which AI service to use.</span>
                                    </li>
                                    [% IF !encryption_ready %]
                                    <li>
                                        <div class="alert alert-warning" style="margin: 6px 0;">
                                            <strong>Encryption key missing:</strong>
                                            Koha encryption_key is not configured in koha-conf.xml. API keys cannot be saved until it is set.
                                        </div>
                                    </li>
                                    [% END %]
                                    <li id="ai-api-key-row" data-openai-set="[% llm_api_key_set ? 1 : 0 %]" data-openrouter-set="[% openrouter_api_key_set ? 1 : 0 %]">
                                        <label for="ai_api_key" id="ai-api-key-label">API Key:</label>
                                        <span id="ai-api-key-indicator" class="ai-key-indicator"></span>
                                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                                            <input type="password" name="ai_api_key" id="ai_api_key" value="" class="form-control" style="width: 300px;" autocomplete="new-password"/>
                                            <button type="button" class="btn btn-xs btn-danger" id="clear-ai-key" disabled>Clear key</button>
                                        </div>
                                        <input type="hidden" name="ai_api_key_clear" id="ai_api_key_clear" value="0"/>
                                        <span class="hint" id="ai-api-key-hint"></span>
                                    </li>
                                    <li id="ai-model-row">
                                        <label for="ai_model">Model:</label>
                                        <div class="table-tools">
                                            <input type="text" id="ai-model-search" class="form-control input-sm" placeholder="Search models..."/>
                                            <select name="ai_model" id="ai_model" class="form-control" style="width: 300px;"></select>
                                            <button type="button" class="btn btn-xs btn-default" id="refresh-ai-models">
                                                <i class="fa fa-refresh"></i> Refresh
                                            </button>
                                        </div>
                                        <div class="openrouter-filters openrouter-only">
                                            <label><input type="checkbox" id="openrouter-filter-text"> text</label>
                                            <label><input type="checkbox" id="openrouter-filter-image"> image</label>
                                            <label><input type="checkbox" id="openrouter-filter-input"> input</label>
                                            <label><input type="checkbox" id="openrouter-filter-output"> output</label>
                                            <label><input type="checkbox" id="openrouter-filter-free"> free</label>
                                        </div>
                                        <span class="hint" id="ai-model-hint"></span>
                                    </li>
                                    <li>
                                        <label for="ai_request_mode">AI Request Mode:</label>
                                        <select name="ai_request_mode" id="ai_request_mode" class="form-control" style="width: 260px;">
                                            <option value="server" selected>Server (Koha)</option>
                                        </select>
                                        <span class="hint">Direct browser mode is disabled to keep provider API keys server-side.</span>
                                    </li>
                                    <li>
                                        <button type="button" class="btn btn-default" id="ai-test-connection">
                                            <i class="fa fa-plug"></i> Test Connection
                                        </button>
                                        <span class="hint">Sends a lightweight request to confirm connectivity.</span>
                                    </li>
                                </ol>
                            </fieldset>
                        </div>
                        <div class="tab-pane fade" id="aacr2-tab-rules" role="tabpanel">
                            <fieldset class="configuration-section">
                                <legend>AACR2 Rules &amp; Live Validation</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="enforce_aacr2_guardrails">Enforce AACR2 Guardrails:</label>
                                        <input type="checkbox" name="enforce_aacr2_guardrails" id="enforce_aacr2_guardrails" value="1" [% IF settings.enforce_aacr2_guardrails %]checked[% END %]/>
                                        <span class="hint">Lock AACR2 rules and MARC21 placement with hard guards and warnings.</span>
                                    </li>
                                    <li>
                                        <label for="enable_live_validation">Enable Live Validation:</label>
                                        <input type="checkbox" name="enable_live_validation" id="enable_live_validation" value="1" [% IF settings.enable_live_validation %]checked[% END %]/>
                                        <span class="hint">Highlight violations in real time as catalogers type.</span>
                                    </li>
                                    <li>
                                        <label for="block_save_on_error">Block Save on Errors:</label>
                                        <input type="checkbox" name="block_save_on_error" id="block_save_on_error" value="1" [% IF settings.block_save_on_error %]checked[% END %]/>
                                        <span class="hint">Disable record save when AACR2 guardrail violations remain.</span>
                                    </li>
                                    <li>
                                        <label for="required_fields">Required AACR2 Fields:</label>
                                        <input type="text" name="required_fields" id="required_fields" value="[% settings.required_fields || '100a,245a,260c,300a,050a' %]" class="form-control"/>
                                        <span class="hint">Comma-separated MARC subfields to enforce (e.g., 100a,245a,260c,300a,050a).</span>
                                    </li>
                                    <li>
                                        <label for="excluded_tags">Excluded Tags (Optional):</label>
                                        <input type="text" name="excluded_tags" id="excluded_tags" value="[% settings.excluded_tags %]" class="form-control"/>
                                        <span class="hint">Comma-separated MARC tags/subfields to skip from automation (e.g., 590a,9XX).</span>
                                    </li>
                                    <li>
                                        <label for="strict_coverage_mode">Strict Coverage Mode:</label>
                                        <input type="checkbox" name="strict_coverage_mode" id="strict_coverage_mode" value="1" [% IF settings.strict_coverage_mode %]checked[% END %]/>
                                        <span class="hint">Warn when a field has no AACR2 rule defined.</span>
                                    </li>
                                    <li>
                                        <label for="enable_local_fields">Enable Local (9XX) Fields:</label>
                                        <input type="checkbox" name="enable_local_fields" id="enable_local_fields" value="1" [% IF settings.enable_local_fields %]checked[% END %]/>
                                        <span class="hint">Default is excluded. Enable to apply AACR2 rules to local fields.</span>
                                    </li>
                                    <li>
                                        <label for="local_fields_allowlist">Local Fields Allowlist:</label>
                                        <input type="text" name="local_fields_allowlist" id="local_fields_allowlist" value="[% settings.local_fields_allowlist %]" class="form-control"/>
                                        <span class="hint">Comma-separated local tags/subfields to include (e.g., 9XX,952a).</span>
                                    </li>
                                </ol>
                            </fieldset>
                            <fieldset class="configuration-section">
                                <legend>Custom AACR2 Rules</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="custom-rules-editor">Custom Rules (JSON):</label>
                                        <textarea name="custom_rules" id="custom-rules-editor">[% settings.custom_rules || '{}' %]</textarea>
                                        <span class="hint">Custom rules are optional. Use {"rules":[{...}]} when adding rules.</span>
                                    </li>
                                    <li>
                                        <label>Import/Export Rules:</label>
                                        <div style="margin-top: 5px;">
                                            <input type="file" name="rules_file" id="rules_file" accept=".json" class="form-control" style="width: auto; display: inline-block;"/>
                                            <button type="submit" name="import_rules" value="1" class="btn btn-default">
                                                <i class="fa fa-upload"></i> Import Rules
                                            </button>
                                            <button type="submit" name="export_rules" value="1" class="btn btn-default">
                                                <i class="fa fa-download"></i> Export Rules
                                            </button>
                                        </div>
                                        <span class="hint">Upload a .json file to import rules or download current rules</span>
                                    </li>
                                </ol>
                            </fieldset>
                            <fieldset class="configuration-section">
                                <legend>Coverage Report</legend>
                                <div class="rows">
                                    <p>Baseline rule pack version: <strong>[% rules_version || 'unknown' %]</strong></p>
                                    <p>
                                        Covered: <strong>[% coverage_summary.covered %]</strong> ·
                                        Excluded: <strong>[% coverage_summary.excluded %]</strong> ·
                                        Not covered: <strong>[% coverage_summary.not_covered %]</strong>
                                    </p>
                                    <span class="hint">This report scans active MARC frameworks and compares tag/subfield coverage.</span>
                                    [% FOREACH framework IN coverage_report %]
                                        <details style="margin-top: 10px;">
                                            <summary>
                                                [% framework.frameworktext || framework.frameworkcode || 'Default' %]
                                                (Total: [% framework.counts.total %], Covered: [% framework.counts.covered %], Excluded: [% framework.counts.excluded %], Missing: [% framework.counts.not_covered %])
                                            </summary>
                                            <table class="coverage-table">
                                                <thead>
                                                    <tr>
                                                        <th>Tag</th>
                                                        <th>Subfield</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    [% FOREACH field IN framework.fields %]
                                                        <tr>
                                                            <td>[% field.tag %]</td>
                                                            <td>[% field.subfield %]</td>
                                                            <td>
                                                                [% IF field.status == 'covered' %]
                                                                    <span class="coverage-status-covered">Covered</span>
                                                                [% ELSIF field.status == 'excluded' %]
                                                                    <span class="coverage-status-excluded">Excluded</span>
                                                                [% ELSE %]
                                                                    <span class="coverage-status-missing">Not covered</span>
                                                                [% END %]
                                                            </td>
                                                        </tr>
                                                    [% END %]
                                                </tbody>
                                            </table>
                                        </details>
                                    [% END %]
                                    <div style="margin-top: 15px;">
                                        <label for="coverage-stubs">Recommended Rule Stubs (JSON):</label>
                                        <textarea id="coverage-stubs" class="form-control" rows="8" readonly>[% coverage_stubs_json %]</textarea>
                                        <span class="hint">Copy and paste into Custom Rules to extend coverage.</span>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                        <div class="tab-pane fade" id="aacr2-tab-training" role="tabpanel">
                            <fieldset class="configuration-section">
                                <legend>Interactive Training Guide</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="enable_guide">Enable Interactive AACR2 Guide:</label>
                                        <input type="checkbox" name="enable_guide" id="enable_guide" value="1" [% IF settings.enable_guide %]checked[% END %]/>
                                        <span class="hint">Enable step-by-step AACR2 guide for training.</span>
                                    </li>
                                    <li>
                                        <label for="guide_users">Exclude Users from Guide:</label>
                                        <div class="table-tools">
                                            <input type="text" id="guide-user-search" class="form-control input-sm" placeholder="Search users..."/>
                                            <select id="guide-user-filter" class="form-control input-sm" style="width: 160px;">
                                                <option value="all">All</option>
                                                <option value="selected">Selected</option>
                                                <option value="unselected">Unselected</option>
                                            </select>
                                        </div>
                                        <table class="user-table" id="guide-users-table">
                                            <thead>
                                                <tr>
                                                    <th>
                                                        <input type="checkbox" id="selectAllGuideUsers" onclick="toggleSelectAll('guide_users', this.checked)"/>
                                                    </th>
                                                    <th class="sortable" data-sort="userid">User ID</th>
                                                    <th class="sortable" data-sort="name">Name</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                [% FOREACH user IN users %]
                                                <tr>
                                                    <td>
                                                        <input type="checkbox" name="guide_users" value="[% user.userid %]"
                                                        [% FOREACH selected_user IN settings.guide_users.split(',') %]
                                                            [% IF selected_user.trim == user.userid %]checked[% END %]
                                                        [% END %]
                                                        [% IF !settings.enable_guide %]disabled class="disabled-checkbox"[% END %]>
                                                    </td>
                                                    <td>[% user.userid %]</td>
                                                    <td>[% user.name %]</td>
                                                </tr>
                                                [% END %]
                                            </tbody>
                                        </table>
                                        <span class="hint">Select users to exclude from accessing the guide (multiple selections allowed)</span>
                                    </li>
                                    <li>
                                        <label for="guide_exclusion_list">Manual Exclusion List (Optional):</label>
                                        <textarea name="guide_exclusion_list" id="guide_exclusion_list" class="exclusion-list form-control">[% settings.guide_exclusion_list %]</textarea>
                                        <span class="hint">Comma-separated usernames to exclude manually (e.g., user1,user2). Matches against loggedinusername class text content.</span>
                                    </li>
                                </ol>
                            </fieldset>
                            <fieldset class="configuration-section">
                                <legend>Internship Training Mode</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="internship_mode">Enable Internship Mode:</label>
                                        <input type="checkbox" name="internship_mode" id="internship_mode" value="1" [% IF settings.internship_mode %]checked[% END %]/>
                                        <span class="hint">Disable auto-punctuation for selected users to support manual learning</span>
                                    </li>
                                    <li>
                                        <label for="internship_users">Select Internship Users:</label>
                                        <div class="table-tools">
                                            <input type="text" id="internship-user-search" class="form-control input-sm" placeholder="Search users..."/>
                                            <select id="internship-user-filter" class="form-control input-sm" style="width: 160px;">
                                                <option value="all">All</option>
                                                <option value="selected">Selected</option>
                                                <option value="unselected">Unselected</option>
                                            </select>
                                        </div>
                                        <table class="user-table" id="internship-users-table">
                                            <thead>
                                                <tr>
                                                    <th>
                                                        <input type="checkbox" id="selectAllInternshipUsers" onclick="toggleSelectAll('internship_users', this.checked)"/>
                                                    </th>
                                                    <th class="sortable" data-sort="userid">User ID</th>
                                                    <th class="sortable" data-sort="name">Name</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                [% FOREACH user IN users %]
                                                <tr>
                                                    <td>
                                                        <input type="checkbox" name="internship_users" value="[% user.userid %]"
                                                        [% FOREACH selected_user IN settings.internship_users.split(',') %]
                                                            [% IF selected_user.trim == user.userid %]checked[% END %]
                                                        [% END %]
                                                        [% IF !settings.internship_mode %]disabled class="disabled-checkbox"[% END %]>
                                                    </td>
                                                    <td>[% user.userid %]</td>
                                                    <td>[% user.name %]</td>
                                                </tr>
                                                [% END %]
                                            </tbody>
                                        </table>
                                        <span class="hint">Select users to exclude from auto-punctuation (multiple selections allowed)</span>
                                    </li>
                                    <li>
                                        <label for="internship_exclusion_list">Manual Exclusion List:</label>
                                        <textarea name="internship_exclusion_list" id="internship_exclusion_list" class="exclusion-list form-control">[% settings.internship_exclusion_list %]</textarea>
                                        <span class="hint">Comma-separated usernames to exclude manually (e.g., user1,user2). Matches against loggedinusername class text content.</span>
                                    </li>
                                </ol>
                            </fieldset>
                            <fieldset class="configuration-section">
                                <legend>Training Progress</legend>
                                <div class="rows">
                                    <div class="progress-controls">
                                        <input type="text" id="progress-search" class="form-control input-sm" placeholder="Search users..."/>
                                        <select id="progress-status-filter" class="form-control input-sm" style="width: 180px;">
                                            <option value="all">All statuses</option>
                                            <option value="completed">Completed</option>
                                            <option value="in_progress">In progress</option>
                                            <option value="not_started">Not started</option>
                                            <option value="no_data">No data</option>
                                        </select>
                                        <button type="button" class="btn btn-default btn-sm" id="progress-refresh">
                                            <i class="fa fa-refresh"></i> Refresh
                                        </button>
                                        <label style="font-weight: normal;">
                                            <input type="checkbox" id="progress-auto-refresh"/> Auto-refresh (30s)
                                        </label>
                                    </div>
                                    <table class="user-table" id="aacr2-progress-table">
                                        <thead>
                                            <tr>
                                                <th class="sortable" data-sort="userid">User ID</th>
                                                <th class="sortable" data-sort="name">Name</th>
                                                <th class="sortable" data-sort="steps_completed">Steps Done</th>
                                                <th class="sortable" data-sort="steps_skipped">Steps Skipped</th>
                                                <th class="sortable" data-sort="updated_at">Last Updated</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="5">Loading progress...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <span class="hint">Progress updates when staff use the AACR2 training guide.</span>
                                </div>
                            </fieldset>
                        </div>
                        <div class="tab-pane fade" id="aacr2-tab-advanced" role="tabpanel">
                            <fieldset class="configuration-section">
                                <legend>Debug &amp; Preview</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="debug_mode">Debug Mode:</label>
                                        <input type="checkbox" name="debug_mode" id="debug_mode" value="1" [% IF settings.debug_mode %]checked[% END %]/>
                                        <span class="hint">Enable console logging for troubleshooting (only enable if needed)</span>
                                    </li>
                                    <li>
                                        <label for="ai_payload_preview">Enable Payload Preview:</label>
                                        <input type="checkbox" name="ai_payload_preview" id="ai_payload_preview" value="1" [% IF settings.ai_payload_preview %]checked[% END %]/>
                                        <span class="hint">Lets admins preview what will be sent to the AI.</span>
                                    </li>
                                </ol>
                            </fieldset>
                            <fieldset class="configuration-section">
                                <legend>AI Safety &amp; Context</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="ai_redaction_rules">Redaction Rules:</label>
                                        <input type="text" name="ai_redaction_rules" id="ai_redaction_rules" value="[% settings.ai_redaction_rules %]" class="form-control"/>
                                        <span class="hint">Tags/subfields to hide before sending to AI (e.g., 9XX,952,5XX).</span>
                                    </li>
                                    <li>
                                        <label for="ai_redact_856_querystrings">Redact 856 $u Querystrings:</label>
                                        <input type="checkbox" name="ai_redact_856_querystrings" id="ai_redact_856_querystrings" value="1" [% IF settings.ai_redact_856_querystrings %]checked[% END %]/>
                                        <span class="hint">Hide URLs with query strings to avoid leaking sensitive links.</span>
                                    </li>
                                    <li>
                                        <label for="ai_context_mode">AI Context Scope:</label>
                                        <select name="ai_context_mode" id="ai_context_mode" class="form-control" style="width: 240px;">
                                            <option value="tag_only" [% IF settings.ai_context_mode == 'tag_only' %]selected[% END %]>Tag only (default)</option>
                                            <option value="tag_plus_neighbors" [% IF settings.ai_context_mode == 'tag_plus_neighbors' %]selected[% END %]>Tag + neighboring fields</option>
                                            <option value="full" [% IF settings.ai_context_mode == 'full' %]selected[% END %]>Full record (redacted)</option>
                                        </select>
                                        <span class="hint">How much of the record is shared with AI. Tag only is safest.</span>
                                    </li>
                                </ol>
                            </fieldset>
                            <fieldset class="configuration-section">
                                <legend>AI Tuning &amp; Limits</legend>
                                <ol class="rows">
                                    <li>
                                        <label for="ai_reasoning_effort">Reasoning/Thinking Effort (OpenAI reasoning models only):</label>
                                        [% SET reasoning_effort = (settings.ai_reasoning_effort || 'low') | lower %]
                                        <select name="ai_reasoning_effort" id="ai_reasoning_effort" class="form-control" style="width: 180px;">
                                            <option value="none" [% IF reasoning_effort == 'none' %]selected[% END %]>None</option>
                                            <option value="low" [% IF reasoning_effort == 'low' %]selected[% END %]>Low</option>
                                            <option value="medium" [% IF reasoning_effort == 'medium' %]selected[% END %]>Medium</option>
                                            <option value="high" [% IF reasoning_effort == 'high' %]selected[% END %]>High</option>
                                        </select>
                                        <span class="hint">Applies only to OpenAI reasoning-capable models (e.g., o-series). Higher effort can increase latency and cost.</span>
                                    </li>
                                    <li>
                                        <label for="ai_timeout">Timeout (seconds):</label>
                                        <input type="number" name="ai_timeout" id="ai_timeout" value="[% settings.ai_timeout %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">How long to wait for the AI before giving up.</span>
                                    </li>
                                    <li>
                                        <label for="ai_max_output_tokens">Max Output Tokens:</label>
                                        <input type="number" name="ai_max_output_tokens" id="ai_max_output_tokens" value="[% settings.ai_max_output_tokens || settings.ai_max_tokens || 1024 %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Higher limits can improve completeness but increase cost/latency. If output is truncated, raise this or reduce reasoning effort.</span>
                                    </li>
                                    <li>
                                        <label for="ai_temperature">Temperature:</label>
                                        <input type="text" name="ai_temperature" id="ai_temperature" value="[% settings.ai_temperature %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Lower = more consistent; higher = more creative.</span>
                                    </li>
                                    <li>
                                        <label for="ai_confidence_threshold">Ghost Confidence Threshold:</label>
                                        <input type="text" name="ai_confidence_threshold" id="ai_confidence_threshold" value="[% settings.ai_confidence_threshold %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Only show AI ghost text when confidence is this high.</span>
                                    </li>
                                    <li>
                                        <label for="ai_rate_limit_per_minute">Rate Limit (per minute):</label>
                                        <input type="number" name="ai_rate_limit_per_minute" id="ai_rate_limit_per_minute" value="[% settings.ai_rate_limit_per_minute %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Max AI requests per minute per staff user.</span>
                                    </li>
                                    <li>
                                        <label for="ai_cache_ttl_seconds">Cache TTL (seconds):</label>
                                        <input type="number" name="ai_cache_ttl_seconds" id="ai_cache_ttl_seconds" value="[% settings.ai_cache_ttl_seconds %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Reuse AI answers for this many seconds to reduce costs.</span>
                                    </li>
                                    <li>
                                        <label for="ai_cache_max_entries">Cache Max Entries:</label>
                                        <input type="number" name="ai_cache_max_entries" id="ai_cache_max_entries" value="[% settings.ai_cache_max_entries %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Upper limit for cached AI responses.</span>
                                    </li>
                                    <li>
                                        <label for="ai_retry_count">Retries:</label>
                                        <input type="number" name="ai_retry_count" id="ai_retry_count" value="[% settings.ai_retry_count %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">How many times to retry when the AI fails.</span>
                                    </li>
                                    <li>
                                        <label for="ai_circuit_breaker_threshold">Circuit Breaker Threshold:</label>
                                        <input type="number" name="ai_circuit_breaker_threshold" id="ai_circuit_breaker_threshold" value="[% settings.ai_circuit_breaker_threshold %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Pause AI after this many consecutive failures.</span>
                                    </li>
                                    <li>
                                        <label for="ai_circuit_breaker_timeout">Circuit Breaker Timeout (seconds):</label>
                                        <input type="number" name="ai_circuit_breaker_timeout" id="ai_circuit_breaker_timeout" value="[% settings.ai_circuit_breaker_timeout %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">How long to pause AI after failures.</span>
                                    </li>
                                    <li>
                                        <label for="ai_circuit_breaker_window_seconds">Circuit Breaker Window (seconds):</label>
                                        <input type="number" name="ai_circuit_breaker_window_seconds" id="ai_circuit_breaker_window_seconds" value="[% settings.ai_circuit_breaker_window_seconds %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Time window for counting failures.</span>
                                    </li>
                                    <li>
                                        <label for="ai_circuit_breaker_failure_rate">Circuit Breaker Failure Rate:</label>
                                        <input type="text" name="ai_circuit_breaker_failure_rate" id="ai_circuit_breaker_failure_rate" value="[% settings.ai_circuit_breaker_failure_rate %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Pause AI if failure rate exceeds this fraction (e.g., 0.5 = 50%).</span>
                                    </li>
                                    <li>
                                        <label for="ai_circuit_breaker_min_samples">Circuit Breaker Min Samples:</label>
                                        <input type="number" name="ai_circuit_breaker_min_samples" id="ai_circuit_breaker_min_samples" value="[% settings.ai_circuit_breaker_min_samples %]" class="form-control" style="width: 120px;"/>
                                        <span class="hint">Minimum requests before failure rate can trigger.</span>
                                    </li>
                                </ol>
                            </fieldset>
                        </div>
                    </div>
                    <fieldset class="action">
                        <input type="submit" value="Save Configuration" class="btn btn-primary"/>
                        <a href="/cgi-bin/koha/plugins/run.pl?class=[% CLASS %]&method=tool" class="btn btn-default">Cancel</a>
                    </fieldset>
                </form>
            </main>
        </div>
        <div class="col-sm-2 col-sm-pull-10">
            <aside>
                [% INCLUDE 'tools-menu.inc' %]
            </aside>
        </div>
    </div>
</div>
<script>
    // Initialize CodeMirror for JSON editor
    var editor = CodeMirror.fromTextArea(document.getElementById('custom-rules-editor'), {
        mode: 'application/json',
        lineNumbers: true,
        theme: 'default',
        lint: true,
        autoCloseBrackets: true,
        matchBrackets: true,
        indentWithTabs: false,
        indentUnit: 2
    });
    var draftKey = 'aacr2-config-draft-v1';
    var draftState = null;
    var draftTimer = null;

    function escapeSelector(value) {
        if (window.CSS && CSS.escape) return CSS.escape(value);
        return value.replace(/([ #;?%&,.+*~\\':"!^$\\[\\]()=>|/@])/g, '\\\\$1');
    }

    function shouldPersistField(el) {
        var name = el.getAttribute('name') || '';
        if (!name) return false;
        if (/api_key/i.test(name)) return false;
        if (name === 'save' || name === 'class' || name === 'method') return false;
        var type = (el.getAttribute('type') || '').toLowerCase();
        if (type === 'password' || type === 'file' || type === 'hidden') return false;
        return true;
    }

    function collectDraftState() {
        var values = {};
        $('form').find('input, select, textarea').each(function() {
            if (!shouldPersistField(this)) return;
            var name = this.getAttribute('name');
            var $el = $(this);
            var type = (this.getAttribute('type') || '').toLowerCase();
            if (type === 'checkbox') {
                values[name] = $el.prop('checked');
                return;
            }
            if (type === 'radio') {
                if ($el.prop('checked')) values[name] = $el.val();
                return;
            }
            if ($el.is('select[multiple]')) {
                values[name] = $el.val() || [];
                return;
            }
            values[name] = $el.val();
        });
        values.__activeTab = $('#aacr2-config-tabs .nav-link.active').attr('href') || '';
        return { ts: Date.now(), values: values };
    }

    function applyDraftState(state) {
        if (!state) return;
        var values = state.values || state;
        if (!values || typeof values !== 'object') return;
        Object.keys(values).forEach(function(name) {
            if (name === '__activeTab') return;
            var selector = '[name="' + escapeSelector(name) + '"]';
            var $els = $(selector);
            if (!$els.length) return;
            var type = ($els.attr('type') || '').toLowerCase();
            var value = values[name];
            if (type === 'checkbox') {
                $els.prop('checked', !!value);
                return;
            }
            if (type === 'radio') {
                $els.filter('[value="' + value + '"]').prop('checked', true);
                return;
            }
            if ($els.is('select[multiple]')) {
                $els.val(Array.isArray(value) ? value : []).trigger('change');
                return;
            }
            $els.val(value);
        });
        if (values.custom_rules && editor) {
            editor.setValue(values.custom_rules);
        }
        if (values.__activeTab) {
            var $tab = $('#aacr2-config-tabs a[href="' + values.__activeTab + '"]');
            if ($tab.length) $tab.trigger('click');
        }
    }

    function saveDraftSoon() {
        if (draftTimer) clearTimeout(draftTimer);
        draftTimer = setTimeout(function() {
            try {
                var snapshot = collectDraftState();
                sessionStorage.setItem(draftKey, JSON.stringify(snapshot));
            } catch (err) {
                // ignore storage failures
            }
        }, 150);
    }

    function loadDraftState() {
        try {
            var raw = sessionStorage.getItem(draftKey);
            return raw ? JSON.parse(raw) : null;
        } catch (err) {
            return null;
        }
    }

    function clearDraftState() {
        try {
            sessionStorage.removeItem(draftKey);
        } catch (err) {
            // ignore storage failures
        }
    }

    // Toggle select all checkboxes
    function toggleSelectAll(className, checked) {
        $('input[type="checkbox"][name="' + className + '"]').prop('checked', checked);
    }

    // Toggle user checkboxes based on mode enable checkbox
    function toggleUserCheckboxes() {
        var isGuideEnabled = $('#enable_guide').is(':checked');
        var isInternshipEnabled = $('#internship_mode').is(':checked');

        $('input[name="guide_users"]')
            .prop('disabled', !isGuideEnabled)
            .toggleClass('disabled-checkbox', !isGuideEnabled);
        $('input[name="internship_users"]')
            .prop('disabled', !isInternshipEnabled)
            .toggleClass('disabled-checkbox', !isInternshipEnabled);
        $('#selectAllGuideUsers')
            .prop('disabled', !isGuideEnabled)
            .toggleClass('disabled-checkbox', !isGuideEnabled);
        $('#selectAllInternshipUsers')
            .prop('disabled', !isInternshipEnabled)
            .toggleClass('disabled-checkbox', !isInternshipEnabled);

        if (!isGuideEnabled) {
            $('input[name="guide_users"]').prop('checked', false);
            $('#selectAllGuideUsers').prop('checked', false);
        }

        if (!isInternshipEnabled) {
            $('input[name="internship_users"]').prop('checked', false);
            $('#selectAllInternshipUsers').prop('checked', false);
        }
    }

    function normalizeText(value) {
        return (value || '').toString().toLowerCase();
    }

    function filterUserTableRows(inputSelector, filterSelector, tableSelector) {
        var query = normalizeText($(inputSelector).val());
        var filter = $(filterSelector).val() || 'all';
        $(tableSelector).find('tbody tr').each(function() {
            var text = normalizeText($(this).text());
            var checked = $(this).find('input[type="checkbox"]').is(':checked');
            var matchesQuery = !query || text.indexOf(query) !== -1;
            var matchesFilter = filter === 'all' || (filter === 'selected' && checked) || (filter === 'unselected' && !checked);
            $(this).toggle(matchesQuery && matchesFilter);
        });
    }

    function sortTableRows(tableSelector, columnIndex, asc) {
        var $tbody = $(tableSelector).find('tbody');
        var rows = $tbody.find('tr').get();
        rows.sort(function(a, b) {
            var textA = normalizeText($(a).children('td').eq(columnIndex).text());
            var textB = normalizeText($(b).children('td').eq(columnIndex).text());
            if (textA < textB) return asc ? -1 : 1;
            if (textA > textB) return asc ? 1 : -1;
            return 0;
        });
        $.each(rows, function(index, row) { $tbody.append(row); });
    }

    function setupSortableTable(tableSelector) {
        var sortState = {};
        $(tableSelector).find('th.sortable').each(function(index) {
            $(this).on('click', function() {
                sortState[index] = !sortState[index];
                sortTableRows(tableSelector, index, sortState[index]);
            });
        });
    }

    function progressStatusFromSummary(summary) {
        var total = summary.total || summary.steps_total || 0;
        var done = (summary.completed_count || summary.steps_completed || 0)
            + (summary.skipped_count || summary.steps_skipped || 0);
        if (!total) return 'no_data';
        if (!done) return 'not_started';
        if (done >= total) return 'completed';
        return 'in_progress';
    }

    function formatTimestamp(epoch) {
        if (!epoch) return '';
        var date = new Date(epoch * 1000);
        return date.toLocaleString();
    }

    function renderProgressTable(rows) {
        var $tbody = $('#aacr2-progress-table tbody');
        $tbody.empty();
        if (!rows || !rows.length) {
            $tbody.append('<tr><td colspan="5">No progress records yet.</td></tr>');
            return;
        }
        rows.forEach(function(row) {
            var summary = row.summary_counts || row.summary || {};
            var status = progressStatusFromSummary(summary);
            var statusLabel = {
                completed: 'Completed',
                in_progress: 'In progress',
                not_started: 'Not started',
                no_data: 'No data'
            }[status] || 'Unknown';
            var done = (summary.completed_count || summary.steps_completed || 0)
                + (summary.skipped_count || summary.steps_skipped || 0);
            var total = summary.total || summary.steps_total || 0;
            var skipped = summary.skipped_count || summary.steps_skipped || 0;
            var $tr = $('<tr>')
                .attr('data-status', status)
                .append('<td>' + (row.userid || '') + '</td>')
                .append('<td>' + (row.name || '') + '</td>')
                .append('<td>' + done + '/' + total + ' (' + statusLabel + ')</td>')
                .append('<td>' + skipped + '</td>')
                .append('<td>' + formatTimestamp(row.updated_at) + '</td>');
            $tbody.append($tr);
        });
    }

    function applyProgressFilters() {
        var query = normalizeText($('#progress-search').val());
        var status = $('#progress-status-filter').val();
        $('#aacr2-progress-table tbody tr').each(function() {
            var rowText = normalizeText($(this).text());
            var rowStatus = $(this).attr('data-status') || '';
            var matchesQuery = !query || rowText.indexOf(query) !== -1;
            var matchesStatus = status === 'all' || status === rowStatus;
            $(this).toggle(matchesQuery && matchesStatus);
        });
    }

    function sanitizeServerMessage(text) {
        return (text || '')
            .toString()
            .replace(/<[^>]*>/g, ' ')
            .replace(/\s+/g, ' ')
            .trim()
            .slice(0, 180);
    }

    function buildHttpError(status, message) {
        var detail = (message || '').toString().trim();
        return 'HTTP ' + status + (detail ? ': ' + detail : '');
    }

    function sessionExpiredMessage(status) {
        return (status === 401 || status === 403)
            ? 'Session expired. Please refresh and log in again.'
            : '';
    }

    function getCsrfToken() {
        var $field = $('#csrf_token');
        var token = $field.length ? ($field.val() || '') : '';
        if (!token) {
            var meta = document.querySelector('meta[name="csrf-token"]');
            token = meta ? (meta.getAttribute('content') || '') : '';
        }
        return token;
    }

    function fetchJson(url, options) {
        var opts = options || {};
        opts.credentials = 'include';
        return fetch(url, opts).then(function(response) {
            var contentType = (response.headers.get('content-type') || '').toLowerCase();
            var isJson = contentType.indexOf('application/json') !== -1;
            if (!response.ok) {
                var sessionMessage = sessionExpiredMessage(response.status);
                if (sessionMessage) {
                    throw new Error(buildHttpError(response.status, sessionMessage));
                }
                if (isJson) {
                    return response.json().then(function(data) {
                        var message = (data && (data.error || data.message)) || '';
                        if (!message && data && data.details) {
                            message = JSON.stringify(data.details);
                        }
                        throw new Error(buildHttpError(response.status, message || 'Request failed.'));
                    }, function() {
                        return response.text().then(function(text) {
                            var message = sanitizeServerMessage(text) || 'Request failed.';
                            throw new Error(buildHttpError(response.status, message));
                        });
                    });
                }
                return response.text().then(function(text) {
                    var message = sanitizeServerMessage(text) || 'Request failed.';
                    throw new Error(buildHttpError(response.status, message));
                });
            }
            if (!isJson) {
                return response.text().then(function(text) {
                    var message = sanitizeServerMessage(text) || 'Non-JSON response from server.';
                    throw new Error(buildHttpError(response.status, message));
                });
            }
            return response.json().then(function(data) {
                return data;
            }, function() {
                return response.text().then(function(text) {
                    var message = sanitizeServerMessage(text) || 'Response was not valid JSON.';
                    throw new Error(buildHttpError(response.status, message));
                });
            });
        });
    }

    function fetchProgressTable(pluginPath) {
        fetchJson(pluginPath + '&method=guide_progress_list', {
            method: 'GET',
            headers: { 'Accept': 'application/json' }
        })
            .then(function(data) {
                renderProgressTable((data && data.users) || []);
                applyProgressFilters();
                setupSortableTable('#aacr2-progress-table');
            })
            .catch(function(err) {
                toastr.error('Progress load failed: ' + err.message);
                $('#aacr2-progress-table tbody').html('<tr><td colspan="5">Unable to load progress.</td></tr>');
            });
    }

    // Document ready function
    $(document).ready(function() {
        var savedSuccessfully = [% saved_successfully ? 1 : 0 %];
        draftState = loadDraftState();
        var pluginPath = '/cgi-bin/koha/plugins/run.pl?class=[% CLASS %]';
        var csrfMeta = document.querySelector('meta[name="csrf-token"]');
        if (csrfMeta) {
            var csrfValue = csrfMeta.getAttribute('content') || '';
            if (csrfValue && $('#csrf_token').length && !$('#csrf_token').val()) {
                $('#csrf_token').val(csrfValue);
            }
        }
        var tabEls = document.querySelectorAll('#aacr2-config-tabs a[data-bs-toggle="tab"]');
        if (window.bootstrap && window.bootstrap.Tab) {
            tabEls.forEach(function(tabEl) {
                tabEl.addEventListener('click', function(event) {
                    event.preventDefault();
                    window.bootstrap.Tab.getOrCreateInstance(tabEl).show();
                });
            });
        } else {
            $('#aacr2-config-tabs a').on('click', function(event) {
                event.preventDefault();
                $('#aacr2-config-tabs .nav-link').removeClass('active');
                $(this).addClass('active');
                $('.tab-pane').removeClass('show active');
                var target = $(this).attr('href') || $(this).data('bs-target');
                if (target) $(target).addClass('show active');
            });
        }
        // Initialize Select2 for multi-select dropdowns
        $('#guide_users, #internship_users').select2({
            placeholder: "Select option",
            allowClear: true,
            width: '100%'
        });
        $('#llm_api_provider').select2({
            minimumResultsForSearch: Infinity,
            width: 'style'
        });

        if (savedSuccessfully) {
            clearDraftState();
        } else if (draftState) {
            applyDraftState(draftState);
        }

        // Toggle user checkboxes based on initial state
        toggleUserCheckboxes();

        // Event handlers for enabling/disabling user checkboxes
        $('#enable_guide').change(toggleUserCheckboxes);
        $('#internship_mode').change(toggleUserCheckboxes);

        // User table search/sort
        function applyGuideUserFilters() {
            filterUserTableRows('#guide-user-search', '#guide-user-filter', '#guide-users-table');
        }
        function applyInternshipUserFilters() {
            filterUserTableRows('#internship-user-search', '#internship-user-filter', '#internship-users-table');
        }
        $('#guide-user-search').on('input', applyGuideUserFilters);
        $('#guide-user-filter').on('change', applyGuideUserFilters);
        $('#guide-users-table').on('change', 'input[type="checkbox"]', applyGuideUserFilters);
        $('#internship-user-search').on('input', applyInternshipUserFilters);
        $('#internship-user-filter').on('change', applyInternshipUserFilters);
        $('#internship-users-table').on('change', 'input[type="checkbox"]', applyInternshipUserFilters);
        setupSortableTable('#guide-users-table');
        setupSortableTable('#internship-users-table');

        // Check if settings were saved successfully
        [% IF saved_successfully %]
            toastr.success('Settings saved successfully!');
        [% END %]

        var modelDefaults = [% model_defaults_json || '{}' %];
        var defaultOpenAiModel = modelDefaults.openai || '';
        var defaultOpenRouterModel = modelDefaults.openrouter || '';
        var fallbackModel = modelDefaults.fallback || '';
        if (!defaultOpenAiModel && fallbackModel && fallbackModel !== 'default' && fallbackModel.indexOf('/') === -1) {
            defaultOpenAiModel = fallbackModel;
        }
        if (!defaultOpenRouterModel && fallbackModel && fallbackModel !== 'default' && fallbackModel.indexOf('/') !== -1) {
            defaultOpenRouterModel = fallbackModel;
        }
        var openAiModels = [];
        var openRouterModels = [];
        var activeProvider = ($('#llm_api_provider').val() || 'OpenRouter').toLowerCase();
        var modelSelections = {
            openai: defaultOpenAiModel || '',
            openrouter: defaultOpenRouterModel || ''
        };
        var modelWarnings = {
            openai: '',
            openrouter: ''
        };
        var draftModelValue = $('#ai_model').val();
        var draftProviderValue = ($('#llm_api_provider').val() || 'OpenRouter').toLowerCase();
        if (draftModelValue) {
            modelSelections[draftProviderValue] = draftModelValue;
        }

        if (!modelSelections.openai && activeProvider === 'openai' && fallbackModel) {
            modelSelections.openai = fallbackModel;
        }
        if (modelSelections.openai === 'default') {
            modelSelections.openai = '';
        }
        function fetchModels(provider, force) {
            var url = pluginPath + '&method=ai_models&provider=' + encodeURIComponent(provider);
            if (force) url += '&force=1';
            return fetchJson(url, { method: 'GET' });
        }

        function setModelSelect($select, models, selectedId, labelFn, options) {
            var opts = options || {};
            var defaultOption = opts.defaultOption;
            $select.empty();
            if (opts.includeBlank !== false) {
                var blank = $('<option>').attr('value', '').text('Select a model');
                if (!selectedId) blank.attr('selected', 'selected');
                $select.append(blank);
            }
            if (defaultOption) {
                var defaultLabel = defaultOption.label || defaultOption.id;
                var defaultItem = $('<option>').attr('value', defaultOption.id).text(defaultLabel);
                if (defaultOption.id === selectedId) defaultItem.attr('selected', 'selected');
                $select.append(defaultItem);
            }
            if (selectedId && (!defaultOption || selectedId !== defaultOption.id)
                && !models.some(function(item) { return item.id === selectedId; })) {
                models = [{ id: selectedId, name: selectedId }].concat(models);
            }
            models.forEach(function(model) {
                var label = labelFn ? labelFn(model) : (model.name || model.id);
                var option = $('<option>').attr('value', model.id).text(label);
                if (model.id === selectedId) option.attr('selected', 'selected');
                $select.append(option);
            });
        }

        function loadOpenAiModels(force, selectedId) {
            fetchModels('openai', force)
                .then(function(data) {
                    if (data && data.error) {
                        toastr.error(data.error);
                        renderOpenAiModels(selectedId);
                        return;
                    }
                    modelWarnings.openai = (data && data.warning) ? data.warning : '';
                    updateModelHint('openai');
                    openAiModels = (data && data.models) ? data.models : [];
                    renderOpenAiModels(selectedId);
                })
                .catch(function(err) {
                    toastr.error('OpenAI models unavailable: ' + err.message);
                    renderOpenAiModels(selectedId);
                });
        }

        function filterOpenAiModels(models) {
            var search = ($('#ai-model-search').val() || '').toLowerCase();
            if (!search) return models;
            return models.filter(function(model) {
                var id = (model.id || '').toLowerCase();
                return id.indexOf(search) !== -1;
            });
        }

        function renderOpenAiModels(selectedId) {
            var filtered = filterOpenAiModels(openAiModels || []);
            var selected = selectedId || $('#ai_model').val() || modelSelections.openai || '';
            setModelSelect($('#ai_model'), filtered, selected, function(model) {
                return model.id;
            }, { includeBlank: true });
        }

        function getModelTokens(model) {
            var tokens = [];
            function addTokens(value) {
                var raw = String(value).toLowerCase();
                raw.split(/[^a-z0-9]+/).forEach(function(token) {
                    if (token) tokens.push(token);
                });
            }
            ['modalities', 'input_modalities', 'output_modalities'].forEach(function(key) {
                var value = model[key];
                if (Array.isArray(value)) {
                    value.forEach(addTokens);
                } else if (value) {
                    addTokens(value);
                }
            });
            var architecture = model.architecture || {};
            ['modality', 'modalities', 'input_modalities', 'output_modalities'].forEach(function(key) {
                var value = architecture[key];
                if (Array.isArray(value)) {
                    value.forEach(addTokens);
                } else if (value) {
                    addTokens(value);
                }
            });
            return tokens;
        }

        function isFreeModel(model) {
            var pricing = model.pricing || {};
            var prompt = parseFloat(pricing.prompt || pricing.input || pricing.prompt_token || pricing.input_price || '1');
            var completion = parseFloat(pricing.completion || pricing.output || pricing.completion_token || pricing.output_price || '1');
            return prompt === 0 && completion === 0;
        }

        function hasModalities(model, key) {
            if (Array.isArray(model[key]) && model[key].length) return true;
            var architecture = model.architecture || {};
            return Array.isArray(architecture[key]) && architecture[key].length;
        }

        function filterOpenRouterModels(models) {
            var search = ($('#ai-model-search').val() || '').toLowerCase();
            var filters = {
                text: $('#openrouter-filter-text').is(':checked'),
                image: $('#openrouter-filter-image').is(':checked'),
                input: $('#openrouter-filter-input').is(':checked'),
                output: $('#openrouter-filter-output').is(':checked'),
                free: $('#openrouter-filter-free').is(':checked')
            };
            return models.filter(function(model) {
                var id = (model.id || '').toLowerCase();
                var name = (model.name || '').toLowerCase();
                var desc = (model.description || '').toLowerCase();
                if (search && id.indexOf(search) === -1 && name.indexOf(search) === -1 && desc.indexOf(search) === -1) {
                    return false;
                }
                var tokens = getModelTokens(model);
                if (filters.text && tokens.length && !tokens.includes('text') && id.indexOf('text') === -1) return false;
                if (filters.image && !tokens.includes('image') && id.indexOf('image') === -1) return false;
                if (filters.input && !hasModalities(model, 'input_modalities')) return false;
                if (filters.output && !hasModalities(model, 'output_modalities')) return false;
                if (filters.free && !isFreeModel(model)) return false;
                return true;
            });
        }

        function renderOpenRouterModels(selectedId) {
            var filtered = filterOpenRouterModels(openRouterModels || []);
            var selected = selectedId || $('#ai_model').val() || modelSelections.openrouter || '';
            setModelSelect($('#ai_model'), filtered, selected, function(model) {
                return model.name ? (model.name + ' (' + model.id + ')') : model.id;
            }, { includeBlank: true });
        }

        function loadOpenRouterModels(force, selectedId) {
            fetchModels('openrouter', force)
                .then(function(data) {
                    if (data && data.error) {
                        toastr.error(data.error);
                        renderOpenRouterModels(selectedId);
                        return;
                    }
                    modelWarnings.openrouter = (data && data.warning) ? data.warning : '';
                    updateModelHint('openrouter');
                    openRouterModels = (data && data.models) ? data.models : [];
                    renderOpenRouterModels(selectedId);
                })
                .catch(function(err) {
                    toastr.error('OpenRouter models unavailable: ' + err.message);
                    renderOpenRouterModels(selectedId);
                });
        }

        function updateModelHint(provider) {
            var normalized = (provider || 'openai').toLowerCase();
            var text = normalized === 'openrouter'
                ? 'Search and filter OpenRouter models (text/image/input/output/free).'
                : 'Search OpenAI model IDs. Filters are available for OpenRouter only.';
            var warning = modelWarnings[normalized] || '';
            if (warning) text += ' ' + warning;
            $('#ai-model-hint').text(text);
        }

        function updateApiKeyUi(provider) {
            var normalized = (provider || 'openrouter').toLowerCase();
            var $row = $('#ai-api-key-row');
            var openaiSet = Number($row.data('openai-set')) === 1;
            var openrouterSet = Number($row.data('openrouter-set')) === 1;
            var isOpenRouter = normalized === 'openrouter';
            var label = isOpenRouter ? 'OpenRouter API Key:' : 'OpenAI API Key:';
            var hint = isOpenRouter
                ? 'OpenRouter API key (stored server-side only).'
                : 'OpenAI API key (stored server-side only).';
            var isSet = isOpenRouter ? openrouterSet : openaiSet;
            if (isSet) hint += ' (set)';
            $('#ai-api-key-label').text(label);
            $('#ai-api-key-hint').text(hint);
            $('#clear-ai-key').prop('disabled', !isSet);
            var $indicator = $('#ai-api-key-indicator');
            if (isSet) {
                $indicator.text('Saved').removeClass('is-empty').addClass('is-set').show();
            } else {
                $indicator.text('Not set').removeClass('is-set').addClass('is-empty').show();
            }
        }

        function toggleAiProviderFields() {
            var provider = ($('#llm_api_provider').val() || 'OpenRouter').toLowerCase();
            var isOpenRouter = provider === 'openrouter';
            $('.openai-only').toggle(!isOpenRouter);
            $('.openrouter-only').toggle(isOpenRouter);
            $('#ai-model-search').prop('disabled', false)
                .attr('placeholder', isOpenRouter ? 'Search OpenRouter models...' : 'Search OpenAI models...');
            $('.openrouter-filters input').prop('disabled', !isOpenRouter);
            $('#ai_api_key_clear').val('0');
            updateModelHint(provider);
            updateApiKeyUi(provider);
        }

        function loadModelsForProvider(provider, force) {
            var normalized = (provider || 'openai').toLowerCase();
            if (normalized === 'openrouter') {
                loadOpenRouterModels(force, modelSelections.openrouter);
            } else {
                loadOpenAiModels(force, modelSelections.openai);
            }
        }

        toggleAiProviderFields();
        loadModelsForProvider($('#llm_api_provider').val() || 'openrouter', false);
        $('#llm_api_provider').on('change', function() {
            modelSelections[activeProvider] = $('#ai_model').val() || modelSelections[activeProvider] || '';
            activeProvider = ($(this).val() || 'OpenRouter').toLowerCase();
            toggleAiProviderFields();
            loadModelsForProvider(activeProvider, false);
        });
        $('#refresh-ai-models').on('click', function() {
            loadModelsForProvider(activeProvider, true);
        });
        $('#ai_model').on('change', function() {
            modelSelections[activeProvider] = $(this).val() || modelSelections[activeProvider] || '';
        });
        $('#ai-model-search').on('input', function() {
            if (activeProvider === 'openrouter') {
                renderOpenRouterModels();
            } else {
                renderOpenAiModels();
            }
        });
        $('.openrouter-filters input').on('change', function() {
            renderOpenRouterModels();
        });

        // Training progress
        fetchProgressTable(pluginPath);
        $('#progress-search').on('input', applyProgressFilters);
        $('#progress-status-filter').on('change', applyProgressFilters);
        $('#progress-refresh').on('click', function() {
            fetchProgressTable(pluginPath);
        });
        var progressTimer = null;
        $('#progress-auto-refresh').on('change', function() {
            var enabled = $(this).is(':checked');
            if (progressTimer) {
                clearInterval(progressTimer);
                progressTimer = null;
            }
            if (enabled) {
                progressTimer = setInterval(function() {
                    fetchProgressTable(pluginPath);
                }, 30000);
            }
        });

        $('#ai-test-connection').on('click', function() {
            toastr.info('Testing AI connection...');
            var csrfToken = getCsrfToken();
            fetchJson(pluginPath + '&method=test_connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({ csrf_token: csrfToken })
            })
                .then(data => {
                    if (data.error) {
                        toastr.error(data.error);
                        return;
                    }
                    toastr.success('AI connection successful.');
                })
                .catch(err => toastr.error('AI connection failed: ' + err.message));
        });
        function setupUnifiedKey() {
            $('#clear-ai-key').on('click', function() {
                var provider = ($('#llm_api_provider').val() || 'OpenRouter').toLowerCase();
                var label = provider === 'openrouter' ? 'OpenRouter' : 'OpenAI';
                if (!confirm('Clear stored ' + label + ' key? This cannot be undone.')) return;
                $('#ai_api_key_clear').val('1');
                $('#ai_api_key').val('');
                var $row = $('#ai-api-key-row');
                if (provider === 'openrouter') {
                    $row.data('openrouter-set', 0);
                } else {
                    $row.data('openai-set', 0);
                }
                updateApiKeyUi(provider);
                toastr.info(label + ' key cleared. Save configuration to apply.');
            });
            $('#ai_api_key').on('input', function() {
                if ($(this).val()) $('#ai_api_key_clear').val('0');
            });
        }

        setupUnifiedKey();

        $('form').on('input change', 'input, select, textarea', function() {
            saveDraftSoon();
        });
        $('#aacr2-config-tabs a').on('click', function() {
            saveDraftSoon();
        });
    });

    // Validate JSON on save
    $('form').on('submit', function(e) {
        if ($(e.target).find('[name="save"]').length) {
            try {
                JSON.parse(editor.getValue());
            } catch (error) {
                e.preventDefault();
                alert('Invalid JSON in custom rules: ' + error.message);
                return false;
            }
        }
    });

    // Auto-format JSON
    $('#custom-rules-editor').next().find('.CodeMirror').after(
        '<button type="button" class="btn btn-sm btn-default" onclick="formatJSON()" style="margin-top: 5px;">' +
        '<i class="fa fa-indent"></i> Format JSON</button>'
    );

    function formatJSON() {
        try {
            var formatted = JSON.stringify(JSON.parse(editor.getValue()), null, 2);
            editor.setValue(formatted);
        } catch (error) {
            alert('Cannot format: Invalid JSON');
        }
    }
</script>
[% INCLUDE 'intranet-bottom.inc' %]
